<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SYSTEM_LEDGER v9.5 // EXPORT_FIX</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        /* DESIGN SPECIFICATION v9.5 */
        :root {
            --font-sans: 'Inter', -apple-system, BlinkMacSystemFont, "Microsoft JhengHei", sans-serif;
            --font-mono: 'JetBrains Mono', monospace;
            --c-income: #059669; --c-expense: #DC2626; --c-credit: #D97706; --c-cost: #EA580C;
            --bg-body: #F3F4F6;
        }
        body { font-family: var(--font-sans); background-color: var(--bg-body); color: #111827; -webkit-font-smoothing: antialiased; }
        .num-font { font-family: var(--font-mono); font-variant-numeric: tabular-nums; letter-spacing: -0.05em; }
        .no-scrollbar::-webkit-scrollbar { display: none; } .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        /* SIDEBAR */
        #sidebar { transition: transform 0.2s cubic-bezier(0.4, 0, 0.2, 1); }
        .nav-item { display: flex; align-items: center; padding: 1rem; border-bottom: 1px solid #1F2937; color: #D1D5DB; font-size: 0.85rem; font-weight: 600; cursor: pointer; transition: all 0.1s; }
        .nav-item:active, .nav-item.active { background-color: #374151; color: #FFFFFF; border-left: 4px solid #FFFFFF; }
        .nav-icon { width: 24px; text-align: center; margin-right: 12px; }

        /* GRID */
        .dash-grid-pro { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1px; background-color: #E5E7EB; border-bottom: 1px solid #E5E7EB; }
        .dash-cell { background-color: #FFFFFF; padding: 0.5rem 0.25rem; text-align: center; display: flex; flex-direction: column; justify-content: center; height: 60px; }
        .dash-cell.secondary { background-color: #F9FAFB; }
        .dash-row-header { grid-column: 1 / -1; background-color: #F3F4F6; color: #4B5563; font-size: 0.65rem; font-weight: 700; padding: 0.25rem 0.5rem; border-bottom: 1px solid #E5E7EB; letter-spacing: 0.05em; }
        .label-xs { font-size: 0.6rem; color: #6B7280; font-weight: 600; margin-bottom: 2px; text-transform: uppercase; }
        .val-md { font-size: 0.9rem; font-weight: 700; }

        /* INPUTS */
        .sys-input { border: 1px solid #D1D5DB; border-radius: 0; padding: 0.5rem; font-size: 0.85rem; background: white; color: #111827; width: 100%; height: 32px; }
        .sys-input:focus { border-color: #111827; outline: none; }

        /* BUTTONS */
        .type-btn { background: #F3F4F6; color: #6B7280; border: 1px solid transparent; font-size: 0.75rem; font-weight: 600; padding: 0.5rem 0; }
        .type-btn.active { background: #FFFFFF; border-color: #D1D5DB; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
        .type-btn.active[data-type="cost"] { color: var(--c-cost); border-bottom: 3px solid var(--c-cost); }
        .type-btn.active[data-type="expense"] { color: var(--c-expense); border-bottom: 3px solid var(--c-expense); }
        .type-btn.active[data-type="income"] { color: var(--c-income); border-bottom: 3px solid var(--c-income); }
        .type-btn.active[data-type="credit"] { color: var(--c-credit); border-bottom: 3px solid var(--c-credit); }

        /* LIST */
        .row-item { display: grid; grid-template-columns: 2.5rem 1fr 4.5rem 2rem; gap: 0.5rem; padding: 0.6rem 0.5rem; border-bottom: 1px solid #F3F4F6; align-items: center; font-size: 0.85rem; }
        .row-header { background: #F9FAFB; font-size: 0.7rem; color: #6B7280; font-weight: 700; padding: 0.5rem; border-bottom: 1px solid #E5E7EB; }
        .tag-type { font-size: 0.6rem; padding: 1px 4px; border-radius: 2px; font-weight: 700; margin-right: 4px; }
        .tag-cost { background: #FFEDD5; color: #C2410C; } .tag-exp { background: #FEE2E2; color: #B91C1C; } .tag-inc { background: #D1FAE5; color: #047857; } .tag-credit { background: #FEF3C7; color: #B45309; }
        
        .btn-delete { width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; color: #D1D5DB; border-radius: 4px; cursor: pointer; }
        .btn-delete:active { background-color: #FEE2E2; color: #DC2626; }

        /* CONFIG DELETE BUTTON */
        .btn-config-del { width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; color: #EF4444; border: 1px solid #FECACA; background-color: #FEF2F2; cursor: pointer; border-radius: 4px; transition: all 0.1s; }
        .btn-config-del:active { background-color: #F87171; color: white; }

        /* CREDIT SPECIFIC */
        .credit-check { appearance: none; width: 1.25rem; height: 1.25rem; border: 2px solid #D1D5DB; border-radius: 4px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s; }
        .credit-check:checked { background-color: #059669; border-color: #059669; }
        .credit-check:checked::after { content: '\2713'; color: white; font-size: 0.8rem; font-weight: bold; }
        .row-credit { display: grid; grid-template-columns: 2rem 2.5rem 1fr 4rem; gap: 0.5rem; padding: 0.75rem 0.5rem; border-bottom: 1px solid #F3F4F6; align-items: center; font-size: 0.85rem; }
        .row-credit.paid .text-info { text-decoration: line-through; color: #9CA3AF; }
        .row-credit.paid .text-amt { color: #059669; }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden bg-white">

    <!-- HEADER -->
    <header class="flex-none bg-white z-20 shadow-sm border-b border-gray-200">
        <div class="px-4 py-3 flex justify-between items-center">
            <div class="flex items-center gap-4">
                <button onclick="toggleSidebar()" class="text-gray-600 hover:text-black"><i class="fas fa-bars text-lg"></i></button>
                <h1 id="page-title" class="font-bold tracking-tight text-gray-900 text-sm">系統控制台 (CONSOLE)</h1>
            </div>
        </div>
    </header>

    <!-- SIDEBAR -->
    <div id="sidebar-overlay" onclick="toggleSidebar()" class="fixed inset-0 bg-black/50 z-40 hidden transition-opacity"></div>
    <nav id="sidebar" class="fixed top-0 left-0 bottom-0 w-64 bg-gray-900 z-50 transform -translate-x-full shadow-2xl flex flex-col">
        <div class="p-5 border-b border-gray-800 text-white font-bold text-lg tracking-wider">SYSTEM_LEDGER</div>
        <div class="flex-1 overflow-y-auto">
            <div onclick="route('home')" class="nav-item active" id="nav-home"><div class="nav-icon"><i class="fas fa-calculator"></i></div>控制台 (CONSOLE)</div>
            <div onclick="route('credit')" class="nav-item" id="nav-credit"><div class="nav-icon"><i class="fas fa-file-invoice-dollar"></i></div>賒帳管理 (CREDIT)</div>
            <div onclick="route('query')" class="nav-item" id="nav-query"><div class="nav-icon"><i class="fas fa-chart-pie"></i></div>商業分析 (BI)</div>
            <div onclick="route('config')" class="nav-item" id="nav-config"><div class="nav-icon"><i class="fas fa-sliders-h"></i></div>系統配置 (CONFIG)</div>
        </div>
        <div class="p-4 border-t border-gray-800 text-gray-500 text-xs font-mono text-center">v9.5 STABLE</div>
    </nav>

    <!-- MAIN -->
    <main class="flex-1 relative overflow-hidden flex flex-col">
        
        <!-- === VIEW: CONSOLE === -->
        <div id="view-home" class="flex flex-col h-full">
            <div class="flex-none overflow-y-auto max-h-[40vh]">
                <div class="border-b border-gray-300">
                    <div class="dash-row-header">今日營運 (TODAY)</div>
                    <div class="dash-grid-pro">
                        <div class="dash-cell"><span class="label-xs text-emerald-700">營業額</span><span id="day-rev" class="num-font val-md text-emerald-700">0</span></div>
                        <div class="dash-cell bg-amber-50"><span class="label-xs text-amber-700">其中:賒帳</span><span id="day-credit" class="num-font val-md text-amber-700">0</span></div>
                        <div class="dash-cell"><span class="label-xs text-blue-600">毛利率</span><span id="day-margin" class="num-font val-md text-blue-600">0%</span></div>
                    </div>
                    <div class="dash-grid-pro">
                        <div class="dash-cell"><span class="label-xs text-orange-600">成本</span><span id="day-cost" class="num-font val-md text-orange-600">0</span></div>
                        <div class="dash-cell"><span class="label-xs text-rose-600">費用</span><span id="day-exp" class="num-font val-md text-rose-600">0</span></div>
                        <div class="dash-cell bg-gray-50"><span class="label-xs text-gray-900">淨利</span><span id="day-net" class="num-font val-md text-gray-900">0</span></div>
                    </div>
                </div>
                <div class="border-b border-gray-300 mt-2">
                    <div class="dash-row-header">全域累計 (TOTAL HISTORY)</div>
                    <div class="dash-grid-pro">
                        <div class="dash-cell secondary"><span class="label-xs text-gray-500">總營業額</span><span id="all-rev" class="num-font val-md text-gray-600">0</span></div>
                        <div class="dash-cell bg-red-50"><span class="label-xs text-red-600 font-bold">待收帳款 (RISK)</span><span id="all-outstanding" class="num-font val-md text-red-600">0</span></div>
                        <div class="dash-cell secondary"><span class="label-xs text-gray-500">平均毛利</span><span id="all-margin" class="num-font val-md text-blue-600/70">0%</span></div>
                    </div>
                    <div class="dash-grid-pro">
                        <div class="dash-cell secondary"><span class="label-xs text-gray-500">總成本</span><span id="all-cost" class="num-font val-md text-gray-600">0</span></div>
                        <div class="dash-cell secondary"><span class="label-xs text-gray-500">總費用</span><span id="all-exp" class="num-font val-md text-gray-600">0</span></div>
                        <div class="dash-cell secondary"><span class="label-xs text-gray-900">總淨資產</span><span id="all-net" class="num-font val-md text-gray-800">0</span></div>
                    </div>
                </div>
            </div>
            <div class="flex-1 overflow-y-auto no-scrollbar bg-white">
                <div class="row-item row-header sticky top-0 z-10"><div class="pl-1">日期</div><div>項目 / 分類</div><div class="text-right">金額</div><div class="text-center"></div></div>
                <div id="home-ledger-list" class="pb-4"></div>
            </div>
            <section class="flex-none bg-white border-t border-gray-200 p-3 pb-safe z-30 shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.05)]">
                <div class="flex rounded-sm overflow-hidden border border-gray-200 mb-2">
                    <button onclick="setType('cost')" class="type-btn active flex-1" data-type="cost">成本</button>
                    <button onclick="setType('expense')" class="type-btn flex-1" data-type="expense">費用</button>
                    <button onclick="setType('income')" class="type-btn flex-1" data-type="income">營收</button>
                    <button onclick="setType('credit')" class="type-btn flex-1" data-type="credit">賒帳</button>
                </div>
                <form onsubmit="commitData(event)" class="grid grid-cols-4 gap-2">
                    <div class="col-span-2"><input type="number" id="in-amt" class="sys-input font-mono font-bold text-lg" placeholder="0.00" step="0.01" required></div>
                    <div class="col-span-2"><select id="in-cat" class="sys-input text-xs font-medium" onchange="updateSubSuggest()"></select></div>
                    <div class="col-span-2 relative"><input type="text" id="in-sub" list="sub-list" class="sys-input text-xs" placeholder="項目說明..."><datalist id="sub-list"></datalist></div>
                    <div class="col-span-2"><input type="date" id="in-date" class="sys-input text-center font-mono text-xs px-0"></div>
                    <button type="submit" class="col-span-4 bg-gray-900 hover:bg-black text-white py-2 text-xs font-bold tracking-widest uppercase">寫入數據</button>
                </form>
            </section>
        </div>

        <!-- === VIEW: CREDIT === -->
        <div id="view-credit" class="hidden flex-col h-full bg-white">
            <div class="p-3 border-b border-gray-200 bg-white shadow-sm flex-none">
                <div class="grid grid-cols-2 gap-3 mb-2">
                    <div><div class="label-xs mb-1">時間維度</div><select id="crm-time-mode" class="sys-input font-mono" onchange="toggleCreditDateInputs()"><option value="day">單獨一日 (SINGLE)</option><option value="range">自定義範圍 (RANGE)</option><option value="all">全域 (ALL)</option></select></div>
                    <div><div class="label-xs mb-1">店鋪</div><select id="crm-cat-filter" class="sys-input" onchange="renderCreditManager()"><option value="all">-- 所有店鋪 --</option></select></div>
                </div>
                <div id="crm-date-inputs" class="grid grid-cols-2 gap-3"><input type="date" id="crm-date-start" class="sys-input font-mono text-center" onchange="renderCreditManager()"><input type="date" id="crm-date-end" class="sys-input font-mono text-center hidden" onchange="renderCreditManager()"></div>
            </div>
            <div class="border-b border-gray-300">
                <div class="dash-row-header bg-amber-50 text-amber-900 border-amber-100 flex justify-between"><span><i class="fas fa-history mr-1"></i> 區間帳務 (PERIOD)</span><span id="crm-period-label" class="font-mono text-[0.6rem] opacity-70"></span></div>
                <div class="dash-grid-pro bg-amber-50/30">
                    <div class="dash-cell bg-transparent"><span class="label-xs text-amber-700">期間新增賒帳</span><span id="crm-period-issued" class="num-font val-md text-amber-800">0</span></div>
                    <div class="dash-cell bg-transparent"><span class="label-xs text-emerald-600">期間已追回</span><span id="crm-period-collected" class="num-font val-md text-emerald-700">0</span></div>
                    <div class="dash-cell bg-transparent"><span class="label-xs text-red-600">期間未追回</span><span id="crm-period-outstanding" class="num-font val-md text-red-700">0</span></div>
                </div>
            </div>
            <div class="border-b border-gray-300">
                <div class="dash-row-header">全域資產狀態 (GLOBAL STOCK)</div>
                <div class="dash-grid-pro">
                    <div class="dash-cell secondary"><span class="label-xs text-gray-500">歷史總賒帳</span><span id="crm-total-issued" class="num-font val-md text-gray-600">0</span></div>
                    <div class="dash-cell secondary"><span class="label-xs text-emerald-600/70">歷史總回收</span><span id="crm-total-collected" class="num-font val-md text-emerald-700/70">0</span></div>
                    <div class="dash-cell bg-red-50"><span class="label-xs text-red-600 font-bold">目前總未收</span><span id="crm-total-outstanding" class="num-font val-md text-red-600">0</span></div>
                </div>
            </div>
            <div class="flex-1 overflow-y-auto no-scrollbar"><div class="row-credit bg-gray-100 font-bold text-xs text-gray-500 border-b border-gray-200 sticky top-0"><div class="text-center">還款</div><div>日期</div><div>對象 / 項目</div><div class="text-right">金額</div></div><div id="credit-list" class="pb-10"></div></div>
        </div>

        <!-- === VIEW: QUERY === -->
        <div id="view-query" class="hidden flex-col h-full bg-gray-50">
            <div class="bg-white border-b border-gray-200 p-3 shadow-sm flex-none space-y-2">
                <div class="grid grid-cols-2 gap-3">
                    <div><div class="label-xs mb-1">時間維度</div><select id="qry-time-mode" class="sys-input font-mono" onchange="toggleQueryDateInputs()"><option value="month">本月</option><option value="day">單獨一日</option><option value="range">自定義範圍</option><option value="year">今年</option><option value="all">全域</option></select></div>
                    <div><div class="label-xs mb-1">指定店鋪</div><select id="qry-cat" class="sys-input font-bold text-blue-800 bg-blue-50 border-blue-200" onchange="runQuery()"><option value="all">-- 所有店鋪 --</option></select></div>
                </div>
                <div id="qry-date-inputs" class="grid grid-cols-2 gap-3 hidden"><input type="date" id="qry-date-start" class="sys-input font-mono text-center" onchange="runQuery()"><input type="date" id="qry-date-end" class="sys-input font-mono text-center hidden" onchange="runQuery()"></div>
                <div><input type="text" id="qry-keyword" class="sys-input" placeholder="關鍵字搜尋..." oninput="runQuery()"></div>
            </div>
            <div class="bg-white border-b border-gray-200 p-3 flex-none">
                <div class="label-xs mb-2 text-gray-800 font-bold border-b border-gray-100 pb-1">分析結果 <span id="qry-period-label" class="font-mono font-normal opacity-50 ml-2"></span></div>
                <div class="grid grid-cols-3 divide-x divide-gray-100 bg-gray-50 border border-gray-100 rounded-t-sm"><div class="p-2 text-center"><div class="label-xs text-emerald-600">總營業額</div><div id="res-rev" class="num-font font-bold text-sm text-gray-900">0</div></div><div class="p-2 text-center"><div class="label-xs text-orange-600">總成本</div><div id="res-cost" class="num-font font-bold text-sm text-gray-900">0</div></div><div class="p-2 text-center"><div class="label-xs text-rose-600">總費用</div><div id="res-exp" class="num-font font-bold text-sm text-gray-900">0</div></div></div>
                <div class="grid grid-cols-2 divide-x divide-gray-100 bg-blue-50 border-x border-b border-blue-100 rounded-b-sm"><div class="p-2 text-center"><div class="label-xs text-blue-700">毛利金額</div><div id="res-gp" class="num-font font-bold text-base text-blue-800">0</div></div><div class="p-2 text-center"><div class="label-xs text-blue-700">毛利率</div><div id="res-margin" class="num-font font-bold text-base text-blue-800">0%</div></div></div>
            </div>
            <div class="flex-1 overflow-y-auto no-scrollbar bg-white"><div class="row-item row-header bg-gray-100 sticky top-0 border-b border-gray-200"><div class="pl-1">日期</div><div>檢索結果 (<span id="res-count">0</span>)</div><div class="text-right">金額</div><div></div></div><div id="query-list" class="pb-10"></div></div>
        </div>

        <!-- === VIEW: CONFIG === -->
        <div id="view-config" class="hidden flex-col h-full bg-white p-4 overflow-y-auto">
            <div class="space-y-6">
                <div>
                    <div class="label-xs mb-2 text-lg border-b border-gray-200 pb-1">分類管理</div>
                    <div class="flex gap-2 mb-3"><input id="new-cat" type="text" class="sys-input text-xs" placeholder="新增分類"><button onclick="sysAddCat()" class="bg-gray-900 text-white px-4 text-xs font-bold hover:bg-black">ADD</button></div>
                    <div id="cat-list" class="border border-gray-200 rounded p-1 space-y-1"></div>
                </div>
                <div>
                    <div class="label-xs mb-2 text-lg border-b border-gray-200 pb-1">數據 I/O</div>
                    <div class="grid grid-cols-2 gap-3 mb-3"><button onclick="sysExport()" class="border border-gray-300 py-2 text-xs font-bold hover:bg-gray-50">導出 JSON</button><button onclick="document.getElementById('file-in').click()" class="border border-gray-300 py-2 text-xs font-bold hover:bg-gray-50">導入 JSON</button><input type="file" id="file-in" class="hidden" onchange="sysImport(this)"></div><button onclick="sysPurge()" class="w-full border border-red-200 text-red-600 py-2 text-xs font-bold hover:bg-red-50">重置系統</button>
                </div>
            </div>
        </div>
    </main>

    <!-- EXPORT MODAL (NEW) -->
    <div id="modal-export" class="hidden fixed inset-0 bg-black/60 backdrop-blur-sm z-[70] flex items-center justify-center">
        <div class="bg-white w-11/12 max-w-sm shadow-2xl rounded-sm overflow-hidden flex flex-col max-h-[80vh]">
            <div class="bg-gray-900 text-white px-4 py-2 flex justify-between items-center"><span class="text-xs font-bold font-mono">DATA_EXPORT</span><button onclick="closeExport()" class="hover:text-gray-300"><i class="fas fa-times"></i></button></div>
            <div class="p-4 flex-1 flex flex-col overflow-hidden">
                <p class="text-xs text-gray-500 mb-2">若檔案未自動下載，請複製下方代碼手動備份：</p>
                <textarea id="export-area" class="flex-1 w-full border border-gray-200 p-2 text-[10px] font-mono bg-gray-50 resize-none mb-3" readonly></textarea>
                <div class="grid grid-cols-2 gap-2"><button onclick="copyExport()" class="bg-emerald-600 text-white py-2 text-xs font-bold hover:bg-emerald-700">複製代碼</button><button onclick="downloadFile()" class="bg-blue-600 text-white py-2 text-xs font-bold hover:bg-blue-700">下載檔案</button></div>
            </div>
        </div>
    </div>

    <!-- ALERT -->
    <div id="modal-alert" class="hidden fixed inset-0 bg-black/60 backdrop-blur-sm z-[60] flex items-center justify-center">
        <div class="bg-white w-72 shadow-2xl rounded-sm overflow-hidden">
            <div class="bg-red-600 text-white px-4 py-2 flex items-center gap-2"><i class="fas fa-exclamation-triangle text-xs"></i><span id="alert-title" class="text-xs font-bold">系統警示</span></div>
            <div class="p-5">
                <div id="alert-msg" class="text-sm font-bold text-gray-900 mb-2">確認執行？</div>
                <div id="alert-detail" class="text-xs text-gray-500 mb-4 font-mono bg-gray-50 p-2 border border-gray-100 rounded hidden"></div>
                <div class="flex gap-2"><button onclick="closeAlert()" class="flex-1 border border-gray-300 py-2 text-xs font-bold text-gray-600 hover:bg-gray-50">取消</button><button onclick="confirmAction()" class="flex-1 bg-red-600 text-white py-2 text-xs font-bold hover:bg-red-700">確認</button></div>
            </div>
        </div>
    </div>

    <script>
        const DB_KEY = 'sys_ledger_v9_5_core';
        const META_KEY = 'sys_ledger_v9_5_meta';
        const DEFAULT_CATS = ['台北總店', '台中分店', '高雄分店', '網路商城', '雜項支出'];
        
        let STATE = { txs: [], cats: [], subs: [], currType: 'cost' };
        
        // Alert State
        let actionType = null; let targetId = null; let targetCat = null;

        window.onload = () => { 
            initSystem(); 
            const today = new Date().toLocaleDateString('en-CA');
            document.getElementById('in-date').value = today; 
            document.getElementById('crm-date-start').value = today;
            document.getElementById('crm-date-end').value = today;
            document.getElementById('qry-date-start').value = today;
            document.getElementById('qry-date-end').value = today;
            renderHome(); 
        };

        function toggleSidebar() {
            const sb = document.getElementById('sidebar'), ov = document.getElementById('sidebar-overlay');
            const isOpen = !sb.classList.contains('-translate-x-full');
            if(isOpen){ sb.classList.add('-translate-x-full'); ov.classList.add('hidden'); }
            else{ sb.classList.remove('-translate-x-full'); ov.classList.remove('hidden'); }
        }

        function route(v) {
            document.querySelectorAll('.nav-item').forEach(e=>e.classList.remove('active'));
            document.getElementById(`nav-${v}`).classList.add('active');
            ['home','credit','query','config'].forEach(id => document.getElementById(`view-${id}`).classList.add('hidden'));
            document.getElementById(`view-${v}`).classList.remove('hidden');
            document.getElementById('page-title').innerText = {'home':'系統控制台 (CONSOLE)','credit':'賒帳管理 (CREDIT)','query':'商業分析 (BI)','config':'系統配置 (CONFIG)'}[v];
            toggleSidebar();
            if(v==='home') renderHome();
            if(v==='credit') { renderQueryCats('crm-cat-filter'); toggleCreditDateInputs(); renderCreditManager(); }
            if(v==='query') { renderQueryCats('qry-cat'); toggleQueryDateInputs(); runQuery(); }
            if(v==='config') renderCatManager();
        }

        function initSystem() {
            try {
                const db = localStorage.getItem(DB_KEY), meta = localStorage.getItem(META_KEY);
                if(db) STATE.txs = JSON.parse(db);
                if(meta) { const m = JSON.parse(meta); STATE.cats = m.cats || DEFAULT_CATS; STATE.subs = m.subs || []; }
                else STATE.cats = DEFAULT_CATS;
            } catch(e) { STATE.cats = DEFAULT_CATS; }
        }
        function persist() {
            localStorage.setItem(DB_KEY, JSON.stringify(STATE.txs));
            localStorage.setItem(META_KEY, JSON.stringify({ cats: STATE.cats, subs: STATE.subs }));
            if(!document.getElementById('view-home').classList.contains('hidden')) renderMetrics();
        }

        function setType(t) { STATE.currType = t; document.querySelectorAll('.type-btn').forEach(b => b.classList.toggle('active', b.dataset.type === t)); }

        function commitData(e) {
            e.preventDefault();
            const amt = parseFloat(document.getElementById('in-amt').value);
            const date = document.getElementById('in-date').value;
            const cat = document.getElementById('in-cat').value;
            const sub = document.getElementById('in-sub').value.trim() || '一般項目';
            if(!amt || !date) return;

            let entry = STATE.subs.find(s => s.cat === cat);
            if(!entry) { entry = { cat, items: [] }; STATE.subs.push(entry); }
            if(!entry.items.includes(sub)) entry.items.push(sub);

            STATE.txs.unshift({ id: Date.now().toString(36), ts: Date.now(), date, type: STATE.currType, cat, sub, amt, isPaid: false });
            persist();
            document.getElementById('in-amt').value = ''; document.getElementById('in-sub').value = ''; document.getElementById('in-amt').focus();
            renderLedgerList();
        }

        // --- EXPORT FIX ---
        function sysExport() {
            const json = JSON.stringify(STATE, null, 2);
            document.getElementById('export-area').value = json;
            document.getElementById('modal-export').classList.remove('hidden');
            downloadFile();
        }
        function downloadFile() {
            const json = document.getElementById('export-area').value;
            const blob = new Blob([json], {type: "application/json"});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `SYSTEM_LEDGER_${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        }
        function copyExport() {
            document.getElementById('export-area').select();
            document.execCommand('copy');
            alert('已複製代碼');
        }
        function closeExport() { document.getElementById('modal-export').classList.add('hidden'); }

        // --- ALERT SYSTEM ---
        function openAlert(title, msg, detail = null) {
            document.getElementById('alert-title').innerText = title;
            document.getElementById('alert-msg').innerText = msg;
            const d = document.getElementById('alert-detail');
            if (detail) { d.innerHTML = detail; d.classList.remove('hidden'); } else { d.classList.add('hidden'); }
            document.getElementById('modal-alert').classList.remove('hidden');
        }
        function closeAlert() {
            document.getElementById('modal-alert').classList.add('hidden');
            actionType = null; targetId = null; targetCat = null;
        }
        function promptDeleteTx(id) {
            const t = STATE.txs.find(x => x.id === id); if (!t) return;
            actionType = 'deleteTx'; targetId = id;
            openAlert('刪除紀錄', '確認移除此筆資料？', `ID: ${id}<br>ITEM: ${t.sub} ($${t.amt})`);
        }
        function promptDelCat(cat) {
            actionType = 'deleteCat'; targetCat = cat;
            openAlert('刪除分類', `確認移除分類「${cat}」？`, '歷史帳務不會刪除，但選單將不再顯示。');
        }
        function sysPurge() {
            actionType = 'purge';
            openAlert('重置系統', '警告：將永久刪除所有資料！', '此操作無法復原。');
        }
        function confirmAction() {
            if (actionType === 'deleteTx' && targetId) {
                STATE.txs = STATE.txs.filter(t => t.id !== targetId);
                persist();
                if(!document.getElementById('view-home').classList.contains('hidden')) renderLedgerList();
                if(!document.getElementById('view-query').classList.contains('hidden')) runQuery();
                if(!document.getElementById('view-credit').classList.contains('hidden')) renderCreditManager();
            } else if (actionType === 'deleteCat' && targetCat) {
                STATE.cats = STATE.cats.filter(c => c !== targetCat);
                persist();
                renderCatManager();
                if(!document.getElementById('view-home').classList.contains('hidden')) renderCats(); 
            } else if (actionType === 'purge') {
                localStorage.clear(); location.reload();
            }
            closeAlert();
        }

        // --- ACCOUNTING METRICS ---
        function renderMetrics() {
            let dCash=0, dCredit=0, dCost=0, dExp=0;
            let aCash=0, aCredit=0, aCost=0, aExp=0, aOut=0;
            const todayStr = document.getElementById('in-date').value || new Date().toLocaleDateString('en-CA');

            STATE.txs.forEach(t => {
                let type = (t.type==='debt'||t.type==='receivable')?'credit':t.type;
                if(type === 'income') aCash += t.amt;
                else if(type === 'credit') { aCredit += t.amt; if(!t.isPaid) aOut += t.amt; }
                else if(type === 'cost') aCost += t.amt;
                else if(type === 'expense') aExp += t.amt;

                if(t.date === todayStr) {
                    if(type === 'income') dCash += t.amt;
                    else if(type === 'credit') dCredit += t.amt;
                    else if(type === 'cost') dCost += t.amt;
                    else if(type === 'expense') dExp += t.amt;
                }
            });

            const dRev = dCash + dCredit; const aRev = aCash + aCredit;
            const dGP = dRev - dCost; const aGP = aRev - aCost;
            const dMargin = dRev > 0 ? (dGP / dRev) * 100 : 0; const aMargin = aRev > 0 ? (aGP / aRev) * 100 : 0;
            const dNet = dGP - dExp; const aNet = aGP - aExp;

            const fmt = new Intl.NumberFormat('en-US');
            document.getElementById('day-rev').innerText = fmt.format(dRev);
            document.getElementById('day-credit').innerText = fmt.format(dCredit);
            document.getElementById('day-margin').innerText = dMargin.toFixed(1) + '%';
            document.getElementById('day-cost').innerText = fmt.format(dCost);
            document.getElementById('day-exp').innerText = fmt.format(dExp);
            document.getElementById('day-net').innerText = fmt.format(dNet);

            document.getElementById('all-rev').innerText = fmt.format(aRev);
            document.getElementById('all-outstanding').innerText = fmt.format(aOut);
            document.getElementById('all-margin').innerText = aMargin.toFixed(1) + '%';
            document.getElementById('all-cost').innerText = fmt.format(aCost);
            document.getElementById('all-exp').innerText = fmt.format(aExp);
            document.getElementById('all-net').innerText = fmt.format(aNet);
        }

        // --- CREDIT MANAGER LOGIC ---
        function toggleCreditDateInputs() {
            const mode = document.getElementById('crm-time-mode').value;
            const start = document.getElementById('crm-date-start');
            const end = document.getElementById('crm-date-end');
            if (mode === 'day') { start.classList.remove('hidden'); end.classList.add('hidden'); } 
            else if (mode === 'range') { start.classList.remove('hidden'); end.classList.remove('hidden'); } 
            else { start.classList.add('hidden'); end.classList.add('hidden'); }
            renderCreditManager();
        }

        function renderCreditManager() {
            const list = document.getElementById('credit-list'); list.innerHTML = '';
            const mode = document.getElementById('crm-time-mode').value;
            const catFilter = document.getElementById('crm-cat-filter').value;
            const startDate = document.getElementById('crm-date-start').value;
            const endDate = document.getElementById('crm-date-end').value;

            let periodLabel = "ALL TIME";
            if(mode === 'day') periodLabel = startDate; else if(mode === 'range') periodLabel = `${startDate} ~ ${endDate}`;
            document.getElementById('crm-period-label').innerText = periodLabel;

            let allCredits = STATE.txs.filter(t => (t.type === 'credit' || t.type === 'receivable' || t.type === 'debt'));
            if(catFilter !== 'all') allCredits = allCredits.filter(t => t.cat === catFilter);

            let totalIssued=0, totalCollected=0, totalOutstanding=0;
            let periodIssued=0, periodCollected=0, periodOutstanding=0;

            allCredits.forEach(t => {
                totalIssued += t.amt; if(t.isPaid) totalCollected += t.amt; else totalOutstanding += t.amt;
            });

            const listItems = allCredits.filter(t => {
                let inRange = true;
                if (mode === 'day') inRange = (t.date === startDate);
                else if (mode === 'range') inRange = (t.date >= startDate && t.date <= endDate);
                if (inRange) { periodIssued += t.amt; if(t.isPaid) periodCollected += t.amt; else periodOutstanding += t.amt; }
                return inRange;
            });

            if(listItems.length === 0) list.innerHTML = '<div class="text-center py-10 text-gray-300 text-xs font-mono">該期間無紀錄</div>';
            else listItems.forEach(t => {
                const row = document.createElement('div');
                row.className = `row-credit ${t.isPaid ? 'paid' : ''}`;
                row.innerHTML = `<div class="flex justify-center"><input type="checkbox" class="credit-check" ${t.isPaid ? 'checked' : ''} onchange="toggleCredit('${t.id}', this)"></div><div class="num-font text-xs text-gray-500">${t.date.slice(5)}</div><div class="text-info truncate"><div class="font-bold text-xs truncate">${t.sub}</div><div class="text-[0.6rem] text-gray-400 font-mono uppercase">${t.cat}</div></div><div class="text-right num-font font-bold text-xs text-amt text-amber-600">$${t.amt.toLocaleString()}</div>`;
                list.appendChild(row);
            });

            const fmt = new Intl.NumberFormat('en-US');
            document.getElementById('crm-period-issued').innerText = fmt.format(periodIssued);
            document.getElementById('crm-period-collected').innerText = fmt.format(periodCollected);
            document.getElementById('crm-period-outstanding').innerText = fmt.format(periodOutstanding);
            document.getElementById('crm-total-issued').innerText = fmt.format(totalIssued);
            document.getElementById('crm-total-collected').innerText = fmt.format(totalCollected);
            document.getElementById('crm-total-outstanding').innerText = fmt.format(totalOutstanding);
        }

        function toggleCredit(id, checkbox) {
            const t = STATE.txs.find(x => x.id === id);
            if(t) { t.isPaid = checkbox.checked; persist(); renderCreditManager(); }
        }

        // --- QUERY LOGIC ---
        function toggleQueryDateInputs() {
            const mode = document.getElementById('qry-time-mode').value;
            const start = document.getElementById('qry-date-start');
            const end = document.getElementById('qry-date-end');
            const needsInputs = (mode === 'day' || mode === 'range');
            const needsEnd = (mode === 'range');
            if(needsInputs) document.getElementById('qry-date-inputs').classList.remove('hidden'); else document.getElementById('qry-date-inputs').classList.add('hidden');
            start.classList.remove('hidden');
            if(needsEnd) end.classList.remove('hidden'); else end.classList.add('hidden');
            runQuery();
        }

        function runQuery() {
            const tm = document.getElementById('qry-time-mode').value;
            const kw = document.getElementById('qry-keyword').value.trim().toLowerCase();
            const cat = document.getElementById('qry-cat').value;
            const now = new Date(); let s, e;
            if(tm==='month'){s=new Date(now.getFullYear(),now.getMonth(),1);e=new Date(now.getFullYear(),now.getMonth()+1,0);}
            else if(tm==='last_month'){s=new Date(now.getFullYear(),now.getMonth()-1,1);e=new Date(now.getFullYear(),now.getMonth(),0);}
            else if(tm==='year'){s=new Date(now.getFullYear(),0,1);e=new Date(now.getFullYear(),11,31);}
            else if(tm==='day') { const d=document.getElementById('qry-date-start').value; if(d){s=new Date(d);e=new Date(d);} }
            else if(tm==='range') { const d1=document.getElementById('qry-date-start').value; const d2=document.getElementById('qry-date-end').value; if(d1)s=new Date(d1); if(d2)e=new Date(d2); }

            let label = ""; if(s&&e){ const fd=d=>d.toISOString().split('T')[0]; if(s.getTime()===e.getTime()) label=fd(s); else label=`${fd(s)} ~ ${fd(e)}`; } else if(tm==='all') label="ALL TIME";
            document.getElementById('qry-period-label').innerText = label;

            const res = STATE.txs.filter(t => {
                if(cat!=='all' && t.cat!==cat) return false;
                if(kw && !(t.sub.toLowerCase().includes(kw) || t.cat.toLowerCase().includes(kw))) return false;
                if(tm!=='all' && s && e) { const d=new Date(t.date); if(d<s || d>e) return false; }
                return true;
            });
            renderQueryResults(res);
        }

        function renderQueryResults(data) {
            let cash=0, credit=0, cost=0, exp=0;
            data.forEach(t => {
                let tp = (t.type==='debt'||t.type==='receivable')?'credit':t.type;
                if(tp==='income') cash+=t.amt; else if(tp==='credit') credit+=t.amt; else if(tp==='cost') cost+=t.amt; else if(tp==='expense') exp+=t.amt;
            });
            const rev = cash + credit; const gp = rev - cost; const m = rev>0?(gp/rev)*100:0;
            const f = new Intl.NumberFormat('en-US');
            document.getElementById('res-rev').innerText = f.format(rev);
            document.getElementById('res-cost').innerText = f.format(cost);
            document.getElementById('res-exp').innerText = f.format(exp);
            document.getElementById('res-gp').innerText = f.format(gp);
            document.getElementById('res-margin').innerText = m.toFixed(1)+'%';
            document.getElementById('res-count').innerText = data.length;
            const l = document.getElementById('query-list'); l.innerHTML = '';
            if(!data.length) l.innerHTML='<div class="text-center py-10 text-gray-300 text-xs font-mono">無符合數據</div>';
            else data.forEach(t => l.appendChild(createRow(t)));
        }

        // --- SHARED ---
        function renderHome() { renderCats(); renderLedgerList(); renderMetrics(); updateSubSuggest(); }
        function renderLedgerList() {
            const list = document.getElementById('home-ledger-list'); list.innerHTML = '';
            const data = STATE.txs.slice(0, 50);
            if(!data.length) { list.innerHTML = '<div class="text-center py-10 text-gray-300 text-xs font-mono">暫無數據</div>'; return; }
            data.forEach(t => list.appendChild(createRow(t)));
        }
        function createRow(t) {
            const row = document.createElement('div'); row.className = 'row-item hover:bg-gray-50 transition-colors';
            let color='text-gray-900', sign='', type=(t.type==='debt'||t.type==='receivable')?'credit':t.type;
            if(type==='income'){color='text-emerald-700';sign='+';} else if(type==='credit'){color='text-amber-700';sign='+';} else if(type==='cost'){color='text-orange-700';sign='-';} else if(type==='expense'){color='text-rose-700';sign='-';}
            row.innerHTML = `<div class="num-font text-xs text-gray-500 pl-1">${t.date.slice(5)}</div><div class="truncate"><div class="font-bold text-gray-900 text-xs truncate">${t.sub}</div><div class="text-[0.6rem] text-gray-400 font-mono uppercase bg-gray-100 px-1 rounded-sm inline-block mt-0.5">${t.cat}</div></div><div class="text-right num-font font-bold text-xs ${color}">${sign}${t.amt.toLocaleString()}</div><div class="text-center flex justify-center"><div onclick="promptDeleteTx('${t.id}')" class="btn-delete" role="button"><i class="fas fa-times"></i></div></div>`;
            return row;
        }
        function renderQueryCats(id) { const s=document.getElementById(id); const v=s.value; s.innerHTML='<option value="all">-- 所有店鋪/分類 --</option>'; STATE.cats.forEach(c=>{const o=document.createElement('option');o.value=c;o.text=c;s.add(o)}); s.value=v; }
        
        function renderCats() { const s=document.getElementById('in-cat'); const v=s.value; s.innerHTML=''; STATE.cats.forEach(c=>{const o=document.createElement('option');o.value=c;o.text=c;s.add(o)}); if(STATE.cats.includes(v))s.value=v; }
        function updateSubSuggest() { const c=document.getElementById('in-cat').value; const l=document.getElementById('sub-list'); l.innerHTML=''; const e=STATE.subs.find(x=>x.cat===c); if(e)e.items.forEach(i=>{const o=document.createElement('option');o.value=i;l.appendChild(o)}); }
        
        function renderCatManager() {
            const l=document.getElementById('cat-list'); l.innerHTML=''; 
            STATE.cats.forEach(c=>{ 
                const d=document.createElement('div'); 
                d.className='flex justify-between items-center text-xs bg-gray-50 px-2 py-2 border-b border-gray-100'; 
                const s = document.createElement('span'); s.innerText = c;
                const b = document.createElement('button');
                b.type = 'button'; b.className = 'btn-config-del';
                b.innerHTML = '<i class="fas fa-times"></i>';
                b.onclick = function() { promptDelCat(c); };
                d.appendChild(s); d.appendChild(b); l.appendChild(d); 
            }); 
        }
        function sysAddCat() { const v=document.getElementById('new-cat').value.trim(); if(v&&!STATE.cats.includes(v)){ STATE.cats.push(v); persist(); renderCatManager(); document.getElementById('new-cat').value=''; } }
        
        function sysImport(i) { const f=i.files[0]; if(!f)return; const r=new FileReader(); r.onload=e=>{ try{ const d=JSON.parse(e.target.result); if(d.txs){ STATE=d; persist(); location.reload(); } }catch(x){ alert('INVALID'); } }; r.readAsText(f); }
    </script>
</body>
</html>


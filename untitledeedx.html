<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SYSTEM_LEDGER v14.0 // SYNC_RELOAD</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        /* DESIGN SPECIFICATION v14.0 */
        :root {
            --font-sans: 'Inter', -apple-system, BlinkMacSystemFont, "Microsoft JhengHei", sans-serif;
            --font-mono: 'JetBrains Mono', monospace;
            --c-income: #059669; --c-expense: #DC2626; --c-credit: #D97706; --c-cost: #EA580C;
            --c-ap: #3B82F6;
            --bg-body: #F3F4F6;
        }
        
        body { 
            position: fixed; inset: 0; width: 100%; height: 100%; overflow: hidden;
            font-family: var(--font-sans); background-color: var(--bg-body); color: #111827;
        }

        .num-font { font-family: var(--font-mono); font-variant-numeric: tabular-nums; letter-spacing: -0.05em; }
        .no-scrollbar::-webkit-scrollbar { display: none; } 
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .scroll-touch { -webkit-overflow-scrolling: touch; }

        /* INDUSTRIAL BUTTONS */
        .btn-industrial {
            background: linear-gradient(180deg, #EF4444 0%, #B91C1C 100%);
            border: 1px solid #7F1D1D;
            box-shadow: inset 0 1px 0 rgba(255,255,255,0.2), 0 2px 4px rgba(0,0,0,0.3);
            color: white; text-shadow: 0 -1px 0 rgba(0,0,0,0.3); transition: all 0.1s;
        }
        .btn-industrial:active { background: linear-gradient(180deg, #991B1B 0%, #7F1D1D 100%); box-shadow: inset 0 2px 5px rgba(0,0,0,0.4); transform: translateY(1px); }

        .btn-industrial-blue {
            background: linear-gradient(180deg, #3B82F6 0%, #1D4ED8 100%);
            border: 1px solid #1E3A8A;
            box-shadow: inset 0 1px 0 rgba(255,255,255,0.2), 0 2px 4px rgba(0,0,0,0.3);
            color: white; text-shadow: 0 -1px 0 rgba(0,0,0,0.3); transition: all 0.1s;
        }
        .btn-industrial-blue:active { background: linear-gradient(180deg, #1E40AF 0%, #1E3A8A 100%); box-shadow: inset 0 2px 5px rgba(0,0,0,0.4); transform: translateY(1px); }

        /* SIDEBAR FIX */
        #sidebar { 
            transition: transform 0.2s cubic-bezier(0.4, 0, 0.2, 1); 
            background-color: #111827 !important; 
            z-index: 9999 !important; 
        }
        .nav-item { display: flex; align-items: center; padding: 1rem; border-bottom: 1px solid #1F2937; color: #D1D5DB; font-size: 0.85rem; font-weight: 600; cursor: pointer; transition: all 0.1s; }
        .nav-item:active, .nav-item.active { background-color: #374151; color: #FFFFFF; border-left: 4px solid #FFFFFF; }
        .nav-icon { width: 24px; text-align: center; margin-right: 12px; }

        /* GRID SYSTEM */
        .dash-grid-pro { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1px; background-color: #E5E7EB; border-bottom: 1px solid #E5E7EB; }
        .dash-grid-dual { display: grid; grid-template-columns: 1fr 1fr; gap: 1px; background-color: #E5E7EB; border-bottom: 1px solid #E5E7EB; }
        .dash-cell { background-color: #FFFFFF; padding: 0.5rem 0.25rem; text-align: center; display: flex; flex-direction: column; justify-content: center; height: 60px; }
        .dash-cell.secondary { background-color: #F9FAFB; }
        .dash-row-header { grid-column: 1 / -1; background-color: #F3F4F6; color: #4B5563; font-size: 0.65rem; font-weight: 700; padding: 0.25rem 0.5rem; border-bottom: 1px solid #E5E7EB; letter-spacing: 0.05em; }
        .label-xs { font-size: 0.6rem; color: #6B7280; font-weight: 600; margin-bottom: 2px; text-transform: uppercase; }
        .val-md { font-size: 0.9rem; font-weight: 700; cursor: pointer; } 

        /* INPUTS & BUTTONS */
        .sys-input { border: 1px solid #D1D5DB; border-radius: 0; padding: 0.5rem; font-size: 0.85rem; background: white; color: #111827; width: 100%; height: 32px; }
        .sys-input:focus { border-color: #111827; outline: none; }
        .sys-input[readonly] { background-color: #F3F4F6; color: #6B7280; cursor: not-allowed; }
        .type-btn { background: #F3F4F6; color: #6B7280; border: 1px solid transparent; font-size: 0.75rem; font-weight: 600; padding: 0.5rem 0; }
        .type-btn.active { background: #FFFFFF; border-color: #D1D5DB; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
        .type-btn.active[data-type="cost"] { color: var(--c-cost); border-bottom: 3px solid var(--c-cost); }
        .type-btn.active[data-type="expense"] { color: var(--c-expense); border-bottom: 3px solid var(--c-expense); }
        .type-btn.active[data-type="income"] { color: var(--c-income); border-bottom: 3px solid var(--c-income); }
        .type-btn.active[data-type="credit"] { color: var(--c-credit); border-bottom: 3px solid var(--c-credit); }
        .type-btn.active[data-type="accounts_payable"] { color: var(--c-ap); border-bottom: 3px solid var(--c-ap); }

        /* LIST & CARDS */
        .row-item { display: grid; grid-template-columns: 5rem 1fr 4.5rem 2rem; gap: 0.5rem; padding: 0.6rem 0.5rem; border-bottom: 1px solid #F3F4F6; align-items: center; font-size: 0.85rem; }
        .row-header { background: #F9FAFB; font-size: 0.7rem; color: #6B7280; font-weight: 700; padding: 0.5rem; border-bottom: 1px solid #E5E7EB; }
        .summary-card { background: white; border: 1px solid #E5E7EB; border-left: 4px solid #6B7280; padding: 1rem; margin-bottom: 0.5rem; cursor: pointer; transition: all 0.1s; display: flex; justify-content: space-between; align-items: center; }
        .summary-card:active { background: #F9FAFB; transform: scale(0.99); }
        .summary-card .store-name { font-weight: 700; font-size: 0.9rem; color: #111827; }
        .summary-card .store-amt { font-family: var(--font-mono); font-weight: 700; font-size: 1rem; color: #374151; }
        .summary-card .store-count { font-size: 0.7rem; color: #9CA3AF; margin-top: 2px; }

        .btn-delete { width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; color: #D1D5DB; border-radius: 4px; cursor: pointer; }
        .btn-delete:active { background-color: #FEE2E2; color: #DC2626; }
        .btn-config-del { width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; color: #EF4444; border: 1px solid #FECACA; background-color: #FEF2F2; cursor: pointer; border-radius: 4px; transition: all 0.1s; }
        .btn-config-del:active { background-color: #F87171; color: white; }
        .btn-edit { width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; color: #3B82F6; border: 1px solid #BFDBFE; background-color: #EFF6FF; cursor: pointer; border-radius: 4px; transition: all 0.1s; margin-right: 4px; }
        .btn-edit:active { background-color: #60A5FA; color: white; }
        .btn-settle { width: 1.75rem; height: 1.75rem; border: 1px solid #D1D5DB; background-color: white; color: #D1D5DB; border-radius: 4px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.1s; }
        .btn-settle:hover { border-color: #059669; color: #059669; background-color: #ECFDF5; }
        .btn-settle:active { background-color: #059669; color: white; }
        
        .row-credit, .row-payable { display: grid; grid-template-columns: 3rem 5rem 1fr 4rem; gap: 0.5rem; padding: 0.75rem 0.5rem; border-bottom: 1px solid #F3F4F6; align-items: center; font-size: 0.85rem; }
        .row-expense { display: grid; grid-template-columns: 5rem 1fr 4rem 2rem; gap: 0.5rem; padding: 0.75rem 0.5rem; border-bottom: 1px solid #F3F4F6; align-items: center; font-size: 0.85rem; }

        /* Pagination & Status */
        .pagination-btn { background: #F3F4F6; color: #6B7280; padding: 0.5rem 0.75rem; font-weight: 600; font-size: 0.75rem; border-radius: 4px; transition: all 0.1s; }
        .pagination-btn:hover:not(:disabled) { background-color: #E5E7EB; }
        .pagination-btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .loading-pulse { animation: pulse-yellow 1.5s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
        @keyframes pulse-yellow { 0%, 100% { opacity: 1; color: #F59E0B; } 50% { opacity: .5; color: #FCD34D; } }
        .status-ready { color: #10B981; } .status-loading { color: #F59E0B; }

        /* TOAST */
        #toast-box { pointer-events: none; opacity: 0; transition: opacity 0.3s; }
        #toast-box.show { opacity: 1; }
        
        .date-cell { cursor: pointer; border-bottom: 1px dashed #D1D5DB; }
        .date-cell:hover { color: #3B82F6; border-color: #3B82F6; }
    </style>
</head>
<body class="flex flex-col bg-white">

    <header class="flex-none bg-white z-20 shadow-sm border-b border-gray-200 h-[50px] flex items-center">
        <div class="px-4 w-full flex justify-between items-center">
            <div class="flex items-center gap-4">
                <button onclick="toggleSidebar()" class="text-gray-600 hover:text-black"><i class="fas fa-bars text-lg"></i></button>
                <h1 id="page-title" class="font-bold tracking-tight text-gray-900 text-sm">系統控制台 (CONSOLE)</h1>
            </div>
            
            <div class="flex items-center gap-3">
                <div class="relative">
                    <button class="btn-industrial-blue w-8 h-8 rounded flex items-center justify-center text-xs font-bold" onclick="document.getElementById('dash-date-picker').showPicker ? document.getElementById('dash-date-picker').showPicker() : document.getElementById('dash-date-picker').focus()" title="選擇日期 (時光機)">
                        <i class="fas fa-calendar-alt"></i>
                    </button>
                    <input type="date" id="dash-date-picker" class="absolute inset-0 opacity-0 w-8 h-8 cursor-pointer z-10" onchange="updateDashboardDate(this.value)">
                </div>
                <button onclick="openSmartEntry()" class="btn-industrial w-8 h-8 rounded flex items-center justify-center text-xs font-bold" title="智慧計算"><i class="fas fa-box-open"></i></button>
                <button onclick="showSyncStatus()" class="flex items-center space-x-0.5 focus:outline-none" id="status-indicator">
                    <i class="fas fa-circle text-[6px] status-loading loading-pulse" id="status-dot-1"></i>
                    <i class="fas fa-circle text-[6px] status-loading loading-pulse" id="status-dot-2"></i>
                    <i class="fas fa-circle text-[6px] status-loading loading-pulse" id="status-dot-3"></i>
                </button>
            </div>
        </div>
    </header>

    <div id="sidebar-overlay" onclick="toggleSidebar()" class="fixed inset-0 bg-black/50 z-40 hidden transition-opacity"></div>
    <nav id="sidebar" class="fixed top-0 left-0 bottom-0 w-64 bg-gray-900 z-50 transform -translate-x-full shadow-2xl flex flex-col">
        <div class="p-5 border-b border-gray-800 text-white font-bold text-lg tracking-wider">SYSTEM_LEDGER</div>
        <div class="flex-1 overflow-y-auto">
            <div onclick="route('home')" class="nav-item active" id="nav-home"><div class="nav-icon"><i class="fas fa-calculator"></i></div>控制台 (CONSOLE)</div>
            <div onclick="route('credit')" class="nav-item" id="nav-credit"><div class="nav-icon"><i class="fas fa-file-invoice-dollar"></i></div>賒帳管理 (CREDIT)</div>
            <div onclick="route('payable')" class="nav-item" id="nav-payable"><div class="nav-icon"><i class="fas fa-money-check-alt"></i></div>賒購分析 (AP)</div>
            <div onclick="route('expense')" class="nav-item" id="nav-expense"><div class="nav-icon"><i class="fas fa-receipt"></i></div>費用管理 (EXPENSE)</div>
            <div onclick="route('query')" class="nav-item" id="nav-query"><div class="nav-icon"><i class="fas fa-chart-pie"></i></div>商業分析 (BI)</div>
            <div onclick="route('config')" class="nav-item" id="nav-config"><div class="nav-icon"><i class="fas fa-sliders-h"></i></div>系統配置 (CONFIG)</div>
        </div>
        <div class="p-4 border-t border-gray-800 text-gray-500 text-xs font-mono text-center">v14.0 SYNC_RELOAD</div>
    </nav>

    <main class="flex-1 relative w-full overflow-hidden">
        
        <div id="view-home" class="absolute inset-0 flex flex-col bg-white z-0">
            <div class="flex-none overflow-y-auto max-h-[40vh] border-b border-gray-200">
                <div class="border-b border-gray-300">
                    <div class="dash-row-header">今日營運 (<span id="current-system-date">TODAY</span>)</div>
                    <div class="dash-grid-pro">
                        <div class="dash-cell">
                            <span class="label-xs text-emerald-700">營業額 <span id="day-rev-count" class="text-emerald-500 font-normal"></span></span>
                            <span id="day-rev" class="num-font val-md text-emerald-700">0</span>
                        </div>
                        <div class="dash-cell bg-amber-50">
                            <span class="label-xs text-amber-700">其中:賒帳 <span id="day-credit-count" class="text-amber-500 font-normal"></span></span>
                            <span id="day-credit" class="num-font val-md text-amber-700">0</span>
                        </div>
                        <div class="dash-cell"><span class="label-xs text-blue-600">毛利率</span><span id="day-margin" class="num-font val-md text-blue-600">0%</span></div>
                    </div>
                    <div class="dash-grid-pro">
                        <div class="dash-cell"><span class="label-xs text-orange-600">成本</span><span id="day-cost" class="num-font val-md text-orange-600">0</span></div>
                        <div class="dash-cell"><span class="label-xs text-rose-600">費用</span><span id="day-exp" class="num-font val-md text-rose-600">0</span></div>
                        <div class="dash-cell bg-gray-50"><span class="label-xs text-gray-900">淨利</span><span id="day-net" class="num-font val-md text-gray-900">0</span></div>
                    </div>
                </div>
                <div class="border-b border-gray-300 mt-2">
                    <div class="dash-row-header">全域累計 (TOTAL HISTORY)</div>
                    <div class="dash-grid-pro" id="global-metrics-container">
                        <div class="dash-cell secondary col-span-3"><span class="label-xs text-gray-400 animate-pulse">讀取中...</span></div>
                    </div>
                    <div class="dash-grid-pro hidden" id="global-metrics-content">
                        <div class="dash-cell secondary"><span class="label-xs text-gray-500">總營業額</span><span id="all-rev" class="num-font val-md text-gray-600">0</span></div>
                        <div class="dash-cell bg-red-50"><span class="label-xs text-red-600 font-bold">待收帳款 (RISK)</span><span id="all-outstanding" class="num-font val-md text-red-600">0</span></div>
                        <div class="dash-cell secondary"><span class="label-xs text-gray-500">平均毛利</span><span id="all-margin" class="num-font val-md text-blue-600/70">0%</span></div>
                    </div>
                </div>
            </div>

            <div class="flex-1 overflow-y-auto scroll-touch relative bg-white">
                <div class="row-item row-header sticky top-0 z-10 shadow-sm"><div class="pl-1">日期</div><div>項目 / 分類 (最近 100 筆)</div><div class="text-right">金額</div><div class="text-center"></div></div>
                <div id="home-ledger-list" class="pb-32"></div>
            </div>

            <section class="absolute bottom-0 left-0 right-0 bg-white border-t border-gray-200 p-3 z-30 shadow-[0_-4px_10px_rgba(0,0,0,0.1)]">
                <div class="flex rounded-sm overflow-hidden border border-gray-200 mb-2">
                    <button onclick="setType('cost')" class="type-btn active flex-1" data-type="cost">成本</button>
                    <button onclick="setType('expense')" class="type-btn flex-1" data-type="expense">費用</button>
                    <button onclick="setType('income')" class="type-btn flex-1" data-type="income">營收</button>
                    <button onclick="setType('credit')" class="type-btn flex-1" data-type="credit">賒帳</button>
                    <button onclick="setType('accounts_payable')" class="type-btn flex-1" data-type="accounts_payable">賒購(AP)</button>
                </div>
                <form onsubmit="commitData(event)" class="grid grid-cols-4 gap-2">
                    <div class="col-span-2"><input type="number" step="0.01" id="in-amt" class="sys-input font-mono font-bold text-lg" placeholder="0.00" required></div>
                    <div class="col-span-2"><select id="in-cat" class="sys-input text-xs font-medium" onchange="updateSubSuggest(); renderCats();"></select></div>
                    <div class="col-span-2 relative"><input type="text" id="in-sub" list="sub-list" class="sys-input text-xs" placeholder="項目說明..."><datalist id="sub-list"></datalist></div>
                    <div class="col-span-2"><input type="date" id="in-date" class="sys-input text-center font-mono text-xs px-0"></div>
                    <button type="submit" class="col-span-4 bg-gray-900 hover:bg-black text-white py-2 text-xs font-bold tracking-widest uppercase">寫入數據</button>
                </form>
            </section>
        </div>

        <div id="modal-smart-entry" class="hidden fixed inset-0 bg-black/70 backdrop-blur-sm z-50 flex items-center justify-center">
            <div class="bg-white w-[90%] max-w-sm rounded shadow-2xl overflow-hidden">
                <div class="bg-gradient-to-r from-red-700 to-red-800 text-white p-3 flex justify-between items-center border-b border-red-900">
                    <div class="font-bold tracking-widest text-sm flex items-center gap-2"><i class="fas fa-box-open"></i> 智慧計算</div>
                    <div class="flex items-center gap-3">
                        <button onclick="toggleSmartLock()" id="btn-smart-lock" class="text-red-200 hover:text-white text-sm" title="鎖定日期"><i class="fas fa-lock-open"></i></button>
                        <button onclick="closeSmartEntry()" class="text-red-200 hover:text-white"><i class="fas fa-times"></i></button>
                    </div>
                </div>
                <div class="p-4 space-y-3">
                    <div class="grid grid-cols-5 gap-2">
                        <div class="col-span-3">
                            <div class="label-xs mb-1">商品名稱</div>
                            <select id="sm-product" class="sys-input font-bold" onchange="onProductSelect()"><option value="">-- 選擇商品 --</option></select>
                        </div>
                        <div class="col-span-2">
                            <div class="label-xs mb-1">單價 (元/市斤)</div>
                            <input type="number" id="sm-price" step="0.1" class="sys-input font-mono text-center text-red-700 font-bold" oninput="calcTotal()" placeholder="0.0">
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-2 bg-gray-50 p-2 rounded border border-gray-200">
                        <div>
                            <div class="label-xs mb-1 text-center">公斤 (KG)</div>
                            <input type="number" id="sm-kg" step="0.01" class="sys-input font-mono text-center font-bold text-lg" oninput="syncWeight('kg')" placeholder="0">
                        </div>
                        <div class="hidden"></div>
                        <div style="grid-column: 2;">
                            <div class="label-xs mb-1 text-center">市斤 (500g)</div>
                            <input type="number" id="sm-jin" step="0.01" class="sys-input font-mono text-center font-bold text-lg" oninput="syncWeight('jin')" placeholder="0">
                        </div>
                    </div>
                    <div>
                        <div class="label-xs mb-1">總金額 (自動計算)</div>
                        <input type="text" id="sm-total" readonly class="sys-input font-mono font-bold text-2xl text-center bg-gray-100 text-gray-900" value="0.00">
                    </div>
                    <div class="border-t border-gray-100 my-2"></div>
                    <div class="grid grid-cols-2 gap-2">
                        <div>
                            <div class="label-xs mb-1">店鋪</div>
                            <select id="sm-cat" class="sys-input text-xs"></select>
                        </div>
                        <div>
                            <div class="label-xs mb-1">類型</div>
                            <select id="sm-type" class="sys-input text-xs font-bold">
                                <option value="income" class="text-emerald-700">營收 (Income)</option>
                                <option value="credit" class="text-amber-700">賒帳 (Credit)</option>
                            </select>
                        </div>
                    </div>
                     <div>
                        <div class="label-xs mb-1">日期</div>
                        <input type="date" id="sm-date" class="sys-input text-center font-mono">
                    </div>
                    <button onclick="commitSmartData()" class="w-full bg-red-700 hover:bg-red-800 text-white py-3 text-sm font-bold tracking-widest uppercase rounded shadow-lg mt-2">確認寫入 (COMMIT)</button>
                </div>
            </div>
        </div>

        <div id="modal-date-edit" class="hidden fixed inset-0 bg-black/70 backdrop-blur-sm z-[70] flex items-center justify-center">
            <div class="bg-white w-64 rounded shadow-2xl p-4">
                <div class="text-sm font-bold text-gray-900 mb-3">修改訂單日期</div>
                <input type="date" id="edit-date-input" class="sys-input text-center mb-3">
                <div class="flex gap-2">
                    <button onclick="document.getElementById('modal-date-edit').classList.add('hidden')" class="flex-1 border border-gray-300 py-1 text-xs">取消</button>
                    <button onclick="commitDateEdit()" class="flex-1 bg-blue-600 text-white py-1 text-xs font-bold">確認</button>
                </div>
            </div>
        </div>

        <div id="modal-alert" class="hidden fixed inset-0 bg-black/60 backdrop-blur-sm z-[60] flex items-center justify-center">
            <div class="bg-white w-72 shadow-2xl rounded-sm overflow-hidden">
                <div class="bg-red-600 text-white px-4 py-2 flex items-center gap-2"><i class="fas fa-exclamation-triangle text-xs"></i><span id="alert-title" class="text-xs font-bold">系統警示</span></div>
                <div class="p-5">
                    <div id="alert-msg" class="text-sm font-bold text-gray-900 mb-2">確認執行？</div>
                    <div id="alert-detail" class="text-xs text-gray-500 mb-4 font-mono bg-gray-50 p-2 border border-gray-100 rounded hidden"></div>
                    <div class="flex gap-2"><button onclick="closeAlert()" class="flex-1 border border-gray-300 py-2 text-xs font-bold text-gray-600 hover:bg-gray-50">取消</button><button onclick="confirmAction()" class="flex-1 bg-red-600 text-white py-2 text-xs font-bold hover:bg-red-700">確認</button></div>
                </div>
            </div>
        </div>

        <div id="view-credit" class="hidden absolute inset-0 flex flex-col bg-white z-0">
            <div class="flex-none bg-white z-10 shadow-sm"><div class="p-3 border-b border-gray-200 bg-white"><div class="grid grid-cols-2 gap-3 mb-2"><div><div class="label-xs mb-1">時間維度</div><select id="crm-time-mode" class="sys-input font-mono" onchange="toggleCreditDateInputs()"><option value="day">單獨一日</option><option value="range">自定義範圍</option><option value="all">全域</option></select></div><div><div class="label-xs mb-1">店鋪</div><select id="crm-cat-filter" class="sys-input" onchange="renderCreditManager()"><option value="all">-- 所有店鋪 (總覽) --</option></select></div></div><div id="crm-date-inputs" class="grid grid-cols-2 gap-3"><input type="date" id="crm-date-start" class="sys-input font-mono text-center" onchange="renderCreditManager()"><input type="date" id="crm-date-end" class="sys-input font-mono text-center hidden" onchange="renderCreditManager()"></div></div><div class="border-b border-gray-300"><div class="dash-row-header bg-amber-50 text-amber-900 border-amber-100 flex justify-between"><span><i class="fas fa-history mr-1"></i> 區間帳務</span><span id="crm-period-label" class="font-mono text-[0.6rem] opacity-70"></span></div><div class="dash-grid-dual bg-amber-50/30"><div class="dash-cell bg-transparent"><span class="label-xs text-amber-700">期間新增賒帳</span><span id="crm-period-issued" class="num-font val-md text-amber-800">0</span></div><div class="dash-cell bg-transparent"><span class="label-xs text-red-600">期間未追回</span><span id="crm-period-outstanding" class="num-font val-md text-red-700">0</span></div></div></div><div class="border-b border-gray-300"><div class="dash-row-header">全域資產狀態</div><div class="dash-grid-dual"><div class="dash-cell secondary"><span class="label-xs text-gray-500">歷史總賒帳</span><span id="crm-total-issued" class="num-font val-md text-gray-600">0</span></div><div class="dash-cell bg-red-50"><span class="label-xs text-red-600 font-bold">目前總未收</span><span id="crm-total-outstanding" class="num-font val-md text-red-600">0</span></div></div></div></div><div class="flex-1 overflow-y-auto scroll-touch bg-gray-50 relative"><div id="crm-list-header" class="row-credit bg-gray-100 font-bold text-xs text-gray-500 border-b border-gray-200 sticky top-0 z-20 shadow-sm"><div class="text-center">結清</div><div>日期</div><div>對象 / 項目</div><div class="text-right">金額</div></div><div id="credit-list" class="pb-24"></div></div><section class="flex-none bg-white border-t border-gray-200 p-3 z-30 shadow-[0_-4px_10px_rgba(0,0,0,0.05)] sticky bottom-0"><div class="flex justify-between items-center text-xs font-mono"><span id="credit-page-info" class="text-gray-600">Page 1 / 1 (Total 0)</span><div class="flex gap-2"><button onclick="changePage('credit', -1)" id="credit-btn-prev" class="pagination-btn" disabled><i class="fas fa-chevron-left"></i> 上一頁</button><button onclick="changePage('credit', 1)" id="credit-btn-next" class="bg-gray-900 text-white pagination-btn" disabled>下一頁 <i class="fas fa-chevron-right"></i></button></div></div></section></div>
        <div id="view-payable" class="hidden absolute inset-0 flex flex-col bg-white z-0"><div class="flex-none bg-white z-10 shadow-sm"><div class="p-3 border-b border-gray-200 bg-white"><div class="grid grid-cols-2 gap-3 mb-2"><div><div class="label-xs mb-1">時間維度</div><select id="apm-time-mode" class="sys-input font-mono" onchange="togglePayableDateInputs()"><option value="day">單獨一日</option><option value="range">自定義範圍</option><option value="all">全域</option></select></div><div><div class="label-xs mb-1">分類</div><select id="apm-cat-filter" class="sys-input" onchange="renderPayableManager()"><option value="all">-- 所有分類 (總覽) --</option></select></div></div><div id="apm-date-inputs" class="grid grid-cols-2 gap-3"><input type="date" id="apm-date-start" class="sys-input font-mono text-center" onchange="renderPayableManager()"><input type="date" id="apm-date-end" class="sys-input font-mono text-center hidden" onchange="renderPayableManager()"></div></div><div class="border-b border-gray-300"><div class="dash-row-header bg-blue-50 text-blue-900 border-blue-100 flex justify-between"><span><i class="fas fa-hand-holding-usd mr-1"></i> 區間應付</span><span id="apm-period-label" class="font-mono text-[0.6rem] opacity-70"></span></div><div class="dash-grid-dual bg-blue-50/30"><div class="dash-cell bg-transparent"><span class="label-xs text-blue-700">期間新增應付</span><span id="apm-period-issued" class="num-font val-md text-blue-800">0</span></div><div class="dash-cell bg-transparent"><span class="label-xs text-red-600">期間未支付</span><span id="apm-period-outstanding" class="num-font val-md text-red-700">0</span></div></div></div><div class="border-b border-gray-300"><div class="dash-row-header">全域負債狀態</div><div class="dash-grid-dual"><div class="dash-cell secondary"><span class="label-xs text-gray-500">歷史總應付</span><span id="apm-total-issued" class="num-font val-md text-gray-600">0</span></div><div class="dash-cell bg-red-50"><span class="label-xs text-red-600 font-bold">目前總未付</span><span id="apm-total-outstanding" class="num-font val-md text-red-600">0</span></div></div></div></div><div class="flex-1 overflow-y-auto scroll-touch bg-gray-50 relative"><div id="apm-list-header" class="row-payable bg-gray-100 font-bold text-xs text-gray-500 border-b border-gray-200 sticky top-0 z-20 shadow-sm"><div class="text-center">支付</div><div>日期</div><div>對象 / 項目</div><div class="text-right">金額</div></div><div id="payable-list" class="pb-24"></div></div><section class="flex-none bg-white border-t border-gray-200 p-3 z-30 shadow-[0_-4px_10px_rgba(0,0,0,0.05)] sticky bottom-0"><div class="flex justify-between items-center text-xs font-mono"><span id="payable-page-info" class="text-gray-600">Page 1 / 1 (Total 0)</span><div class="flex gap-2"><button onclick="changePage('payable', -1)" id="payable-btn-prev" class="pagination-btn" disabled><i class="fas fa-chevron-left"></i> 上一頁</button><button onclick="changePage('payable', 1)" id="payable-btn-next" class="bg-gray-900 text-white pagination-btn" disabled>下一頁 <i class="fas fa-chevron-right"></i></button></div></div></section></div>
        <div id="view-expense" class="hidden absolute inset-0 flex flex-col bg-white z-0"><div class="flex-none bg-white z-10 shadow-sm"><div class="p-3 border-b border-gray-200 bg-white"><div class="grid grid-cols-2 gap-3 mb-2"><div><div class="label-xs mb-1">時間維度</div><select id="exp-time-mode" class="sys-input font-mono" onchange="toggleExpenseDateInputs()"><option value="day">單獨一日</option><option value="range">自定義範圍</option><option value="all">全域</option></select></div><div><div class="label-xs mb-1">分類/店鋪</div><select id="exp-cat-filter" class="sys-input" onchange="renderExpenseManager()"><option value="all">-- 所有分類 (總覽) --</option></select></div></div><div id="exp-date-inputs" class="grid grid-cols-2 gap-3"><input type="date" id="exp-date-start" class="sys-input font-mono text-center" onchange="renderExpenseManager()"><input type="date" id="exp-date-end" class="sys-input font-mono text-center hidden" onchange="renderExpenseManager()"></div></div><div class="border-b border-gray-300"><div class="dash-row-header bg-rose-50 text-rose-900 border-rose-100 flex justify-between"><span><i class="fas fa-wallet mr-1"></i> 區間總費用</span><span id="exp-period-label" class="font-mono text-[0.6rem] opacity-70"></span></div><div class="dash-cell bg-rose-50/30"><span id="exp-period-total" class="num-font val-md text-rose-700 text-xl">0</span></div></div><div class="border-b border-gray-300"><div class="dash-row-header">歷史總費用 (GLOBAL)</div><div class="dash-cell secondary"><span id="exp-global-total" class="num-font val-md text-gray-600">0</span></div></div></div><div class="flex-1 overflow-y-auto scroll-touch bg-gray-50 relative"><div id="exp-list-header" class="row-expense bg-gray-100 font-bold text-xs text-gray-500 border-b border-gray-200 sticky top-0 z-20 shadow-sm"><div class="text-center">日期</div><div>項目 / 分類</div><div class="text-right">金額</div><div></div></div><div id="expense-list" class="pb-24"></div></div><section class="flex-none bg-white border-t border-gray-200 p-3 z-30 shadow-[0_-4px_10px_rgba(0,0,0,0.05)] sticky bottom-0"><div class="flex justify-between items-center text-xs font-mono"><span id="expense-page-info" class="text-gray-600">Page 1 / 1 (Total 0)</span><div class="flex gap-2"><button onclick="changePage('expense', -1)" id="expense-btn-prev" class="pagination-btn" disabled><i class="fas fa-chevron-left"></i> 上一頁</button><button onclick="changePage('expense', 1)" id="expense-btn-next" class="bg-gray-900 text-white pagination-btn" disabled>下一頁 <i class="fas fa-chevron-right"></i></button></div></div></section></div>
        <div id="view-query" class="hidden absolute inset-0 flex flex-col bg-gray-50 z-0"><div class="flex-none z-10 bg-white"><div class="bg-white border-b border-gray-200 p-3 shadow-sm space-y-2"><div class="grid grid-cols-2 gap-3"><div><div class="label-xs mb-1">時間維度</div><select id="qry-time-mode" class="sys-input font-mono" onchange="toggleQueryDateInputs()"><option value="month">本月</option><option value="day">單獨一日</option><option value="range">自定義範圍</option><option value="year">今年</option><option value="all">全域</option></select></div><div><div class="label-xs mb-1">指定店鋪</div><select id="qry-cat" class="sys-input font-bold text-blue-800 bg-blue-50 border-blue-200" onchange="runQuery()"><option value="all">-- 所有店鋪 (總覽) --</option></select></div></div><div id="qry-date-inputs" class="grid grid-cols-2 gap-3 hidden"><input type="date" id="qry-date-start" class="sys-input font-mono text-center" onchange="runQuery()"><input type="date" id="qry-date-end" class="sys-input font-mono text-center hidden" onchange="runQuery()"></div><div><input type="text" id="qry-keyword" class="sys-input" placeholder="關鍵字搜尋 (輸入強制顯示明細)..." oninput="runQuery()"></div></div><div class="bg-white border-b border-gray-200 p-3"><div class="label-xs mb-2 text-gray-800 font-bold border-b border-gray-100 pb-1 flex justify-between"><span>分析結果 <span id="qry-period-label" class="font-mono font-normal opacity-50 ml-2"></span></span><span class="text-blue-600">總銷量: <span id="res-volume" class="font-bold cursor-pointer">0</span> 斤</span></div><div class="grid grid-cols-3 divide-x divide-gray-100 bg-gray-50 border border-gray-100 rounded-t-sm"><div class="p-2 text-center"><div class="label-xs text-emerald-600">總營業額</div><div id="res-rev" class="num-font font-bold text-sm text-gray-900 cursor-pointer">0</div></div><div class="p-2 text-center"><div class="label-xs text-orange-600">總成本</div><div id="res-cost" class="num-font font-bold text-sm text-gray-900 cursor-pointer">0</div></div><div class="p-2 text-center"><div class="label-xs text-rose-600">總費用</div><div id="res-exp" class="num-font font-bold text-sm text-gray-900 cursor-pointer">0</div></div></div><div class="grid grid-cols-3 divide-x divide-gray-100 bg-blue-50 border-x border-b border-blue-100 rounded-b-sm"><div class="p-2 text-center"><div class="label-xs text-blue-700">毛利金額</div><div id="res-gp" class="num-font font-bold text-base text-blue-800 cursor-pointer">0</div></div><div class="p-2 text-center"><div class="label-xs text-blue-700">毛利率</div><div id="res-margin" class="num-font font-bold text-base text-blue-800">0%</div></div><div class="p-2 text-center bg-gray-100"><div class="label-xs text-gray-900 font-bold">淨利 (NET)</div><div id="res-net" class="num-font font-bold text-base text-gray-900 cursor-pointer">0</div></div></div></div></div><div class="flex-1 overflow-y-auto scroll-touch bg-white relative"><div id="qry-list-header" class="row-item row-header bg-gray-100 sticky top-0 border-b border-gray-200 z-20 shadow-sm"><div class="pl-1">日期</div><div>檢索結果 (<span id="res-count">0</span>)</div><div class="text-right">金額</div><div></div></div><div id="query-list" class="pb-24"></div></div><section class="flex-none bg-white border-t border-gray-200 p-3 z-30 shadow-[0_-4px_10px_rgba(0,0,0,0.05)] sticky bottom-0"><div class="flex justify-between items-center text-xs font-mono"><span id="query-page-info" class="text-gray-600">Page 1 / 1 (Total 0)</span><div class="flex gap-2"><button onclick="changePage('query', -1)" id="query-btn-prev" class="pagination-btn" disabled><i class="fas fa-chevron-left"></i> 上一頁</button><button onclick="changePage('query', 1)" id="query-btn-next" class="bg-gray-900 text-white pagination-btn" disabled>下一頁 <i class="fas fa-chevron-right"></i></button></div></div></section></div>
        <div id="view-config" class="hidden absolute inset-0 flex flex-col bg-white p-4 overflow-y-auto scroll-touch z-0"><div class="space-y-6 pb-20"><div><div class="label-xs mb-2 text-lg border-b border-gray-200 pb-1">商品管理 (進銷存)</div><div class="grid grid-cols-6 gap-2 mb-3"><input id="new-prod-name" type="text" class="col-span-2 sys-input text-xs" placeholder="商品名稱"><input id="new-prod-price" type="number" class="col-span-2 sys-input text-xs" placeholder="單價 (元/斤)"><input id="new-prod-cost" type="number" class="col-span-1 sys-input text-xs text-orange-600 font-bold" placeholder="成本 (元/斤)"><button onclick="sysAddProduct()" class="col-span-1 bg-red-700 text-white text-xs font-bold hover:bg-red-800">ADD</button></div><div id="prod-list" class="border border-gray-200 rounded p-1 space-y-1"></div></div><div><div class="label-xs mb-2 text-lg border-b border-gray-200 pb-1">交易分類管理 (店鋪/費用)</div><div class="flex gap-2 mb-3"><input id="new-cat" type="text" class="sys-input text-xs" placeholder="新增交易分類"><button onclick="sysAddCat()" class="bg-gray-900 text-white px-4 text-xs font-bold hover:bg-black">ADD</button></div><div id="cat-list" class="border border-gray-200 rounded p-1 space-y-1"></div></div><div><div class="label-xs mb-2 text-lg border-b border-gray-200 pb-1">賒購分類管理 (應付對象)</div><div class="flex gap-2 mb-3"><input id="new-ap-cat" type="text" class="sys-input text-xs" placeholder="新增賒購分類"><button onclick="sysAddApCat()" class="bg-gray-900 text-white px-4 text-xs font-bold hover:bg-black">ADD</button></div><div id="ap-cat-list" class="border border-gray-200 rounded p-1 space-y-1"></div></div><div><div class="label-xs mb-2 text-lg border-b border-gray-200 pb-1">數據 I/O</div><div class="grid grid-cols-2 gap-3 mb-3"><button onclick="sysExport()" class="border border-gray-300 py-2 text-xs font-bold hover:bg-gray-50">導出 JSON</button><button onclick="document.getElementById('file-in').click()" class="border border-gray-300 py-2 text-xs font-bold hover:bg-gray-50">導入 JSON</button><input type="file" id="file-in" class="hidden" onchange="sysImport(this)" multiple></div><div class="grid grid-cols-2 gap-3 mb-3"><button onclick="injectMockData(1000)" class="border border-blue-200 text-blue-600 py-2 text-xs font-bold hover:bg-blue-50">寫入 1000 筆 (Normal)</button><button onclick="injectMassiveData()" class="bg-red-50 border border-red-200 text-red-600 py-2 text-xs font-bold hover:bg-red-100">寫入 50 萬筆 (Stress)</button></div><button onclick="sysPurge()" class="w-full border border-red-200 text-red-600 py-2 text-xs font-bold hover:bg-red-50">重置系統 (DB PURGE)</button></div></div></div>
    </main>

    <div id="toast-box" class="fixed bottom-10 left-1/2 transform -translate-x-1/2 bg-gray-900 text-white px-4 py-2 rounded shadow-lg text-sm font-bold z-[100]"></div>

    <div id="modal-alert" class="hidden fixed inset-0 bg-black/60 backdrop-blur-sm z-[60] flex items-center justify-center">
        <div class="bg-white w-72 shadow-2xl rounded-sm overflow-hidden">
            <div class="bg-red-600 text-white px-4 py-2 flex items-center gap-2"><i class="fas fa-exclamation-triangle text-xs"></i><span id="alert-title" class="text-xs font-bold">系統警示</span></div>
            <div class="p-5"><div id="alert-msg" class="text-sm font-bold text-gray-900 mb-2">確認執行？</div><div id="alert-detail" class="text-xs text-gray-500 mb-4 font-mono bg-gray-50 p-2 border border-gray-100 rounded hidden"></div><div class="flex gap-2"><button onclick="closeAlert()" class="flex-1 border border-gray-300 py-2 text-xs font-bold text-gray-600 hover:bg-gray-50">取消</button><button onclick="confirmAction()" class="flex-1 bg-red-600 text-white py-2 text-xs font-bold hover:bg-red-700">確認</button></div></div>
        </div>
    </div>
    <div id="modal-date-edit" class="hidden fixed inset-0 bg-black/70 backdrop-blur-sm z-[70] flex items-center justify-center"><div class="bg-white w-64 rounded shadow-2xl p-4"><div class="text-sm font-bold text-gray-900 mb-3">修改訂單日期</div><input type="date" id="edit-date-input" class="sys-input text-center mb-3"><div class="flex gap-2"><button onclick="document.getElementById('modal-date-edit').classList.add('hidden')" class="flex-1 border border-gray-300 py-1 text-xs">取消</button><button onclick="commitDateEdit()" class="flex-1 bg-blue-600 text-white py-1 text-xs font-bold">確認</button></div></div></div>

    <script>
        const DB_NAME = 'SYS_LEDGER_DB_v4'; const DB_VERSION = 4;
        let db; 
        let STATE = { txs: [], cats: [], apCats: [], subs: [], products: [], currType: 'cost' }; 
        let TODAY_STR = new Date().toLocaleDateString('en-CA');
        let DASHBOARD_TARGET_DATE = TODAY_STR; 
        let IS_FULL_LOADED = false; let IS_RENAMING = false;
        let LOAD_PROGRESS = { current: 0, total: 0, percent: 0 };
        const DEFAULT_CATS = ['台北總店', '台中分店', '高雄分店', '網路商城', '雜項支出'];
        const DEFAULT_AP_CATS = ['供應商 A', '供應商 B', '個人借款']; 
        const PAGINATION_DEFAULTS = { pageSize: 100, currentPage: 1, totalResults: 0, totalPages: 0, currentData: [] };
        let QUERY_PAGINATION = {...PAGINATION_DEFAULTS, view: 'query'};
        let CREDIT_PAGINATION = {...PAGINATION_DEFAULTS, view: 'credit'};
        let PAYABLE_PAGINATION = {...PAGINATION_DEFAULTS, view: 'payable'};
        let EXPENSE_PAGINATION = {...PAGINATION_DEFAULTS, view: 'expense'};
        let actionType = null; let targetId = null; let targetCat = null; let targetProd = null;
        let SMART_DATE_LOCK = false; let SMART_LOCKED_DATE = null; 
        let targetNewName = null; let targetOldName = null; let renameCount = 0; let renameTotal = 0;

        // --- CORE ---
        function openDB() { return new Promise((resolve, reject) => { const req = indexedDB.open(DB_NAME, DB_VERSION); req.onupgradeneeded = (e) => { const db = e.target.result; if (!db.objectStoreNames.contains('txs')) { const store = db.createObjectStore('txs', { keyPath: 'id' }); store.createIndex('date', 'date', { unique: false }); store.createIndex('ts', 'ts', { unique: false }); } if (!db.objectStoreNames.contains('meta')) { db.createObjectStore('meta', { keyPath: 'key' }); } }; req.onsuccess = (e) => { db = e.target.result; resolve(db); }; req.onerror = (e) => reject('DB Error'); }); }
        async function initSystem() { try { await openDB(); await loadMeta(); await loadPriorityData(); renderHome(); renderCatManager(); renderApCatManager(); renderProdManager(); loadBackgroundData(); } catch(e) { console.error(e); alert('Initialization failed'); } }
        function loadMeta() { return new Promise((resolve) => { const tx = db.transaction('meta', 'readonly'); const store = tx.objectStore('meta'); let c=store.get('cats'), ac=store.get('apCats'), s=store.get('subs'), p=store.get('products'); tx.oncomplete = () => { STATE.cats = c.result ? c.result.val : DEFAULT_CATS; STATE.apCats = ac.result ? ac.result.val : DEFAULT_AP_CATS; STATE.subs = s.result ? s.result.val : []; STATE.products = p.result ? p.result.val : []; resolve(); }; }); }
        async function loadPriorityData() { return new Promise((resolve) => { const tx = db.transaction('txs', 'readonly'); const store = tx.objectStore('txs'); const idxDate = store.index('date'), idxTs = store.index('ts'); const todayData = [], top100Data = []; const todayReq = idxDate.getAll(IDBKeyRange.only(TODAY_STR)); const listReq = idxTs.openCursor(null, 'prev'); let count = 0; todayReq.onsuccess = (e) => { todayData.push(...e.target.result); }; listReq.onsuccess = (e) => { const c = e.target.result; if (c && count < 100) { top100Data.push(c.value); count++; c.continue(); } }; tx.oncomplete = () => { const map = new Map(); todayData.forEach(t => map.set(t.id, t)); top100Data.forEach(t => map.set(t.id, t)); STATE.txs = Array.from(map.values()).sort((a,b) => b.ts - a.ts); resolve(); }; }); }
        async function loadBackgroundData() { const tx = db.transaction('txs', 'readonly'); const store = tx.objectStore('txs'); const countReq = store.count(); countReq.onsuccess = () => { LOAD_PROGRESS.total = countReq.result; if(LOAD_PROGRESS.total === 0) { finishLoading([]); return; } const allData = []; const cursorReq = store.openCursor(); cursorReq.onsuccess = (e) => { const cursor = e.target.result; if (cursor) { allData.push(cursor.value); LOAD_PROGRESS.current++; LOAD_PROGRESS.percent = Math.floor((LOAD_PROGRESS.current / LOAD_PROGRESS.total) * 100); cursor.continue(); } else { finishLoading(allData); } }; }; }
        function finishLoading(fullData) { fullData.sort((a,b) => b.ts - a.ts); STATE.txs = fullData; IS_FULL_LOADED = true; updateStatusUI(); if(!document.getElementById('view-home').classList.contains('hidden')) renderMetrics(); }
        
        function updateStatusUI() {
            const dots = [1,2,3].map(i => document.getElementById(`status-dot-${i}`));
            if (IS_RENAMING || !IS_FULL_LOADED) { dots.forEach(d => { d.classList.add('status-loading', 'loading-pulse'); d.classList.remove('status-ready'); }); } 
            else { dots.forEach(d => { d.classList.remove('status-loading', 'loading-pulse'); d.classList.add('status-ready'); }); }
        }
        function showSyncStatus() {
            if (IS_RENAMING) alert(`正在重構數據: ${Math.floor((renameCount / renameTotal) * 100)}%\n(${renameCount} / ${renameTotal})`);
            else if (IS_FULL_LOADED) alert(`系統同步完成。\n總計數據: ${STATE.txs.length} 筆`);
            else alert(`後台同步中...\n進度: ${LOAD_PROGRESS.percent}%\n(${LOAD_PROGRESS.current} / ${LOAD_PROGRESS.total})`);
        }
        
        function saveTx(txItem) { return new Promise((resolve, reject) => { const tx = db.transaction('txs', 'readwrite'); tx.objectStore('txs').put(txItem); tx.oncomplete = () => { const idx = STATE.txs.findIndex(t => t.id === txItem.id); if(idx > -1) STATE.txs[idx] = txItem; else { STATE.txs.unshift(txItem); STATE.txs.sort((a,b)=>b.ts-a.ts); } resolve(); }; tx.onerror = () => reject(); }); }
        function deleteTxDB(id) { return new Promise((resolve, reject) => { const tx = db.transaction('txs', 'readwrite'); tx.objectStore('txs').delete(id); tx.oncomplete = () => { STATE.txs = STATE.txs.filter(t => t.id !== id); resolve(); }; tx.onerror = () => reject(); }); }
        function saveMeta() { const tx = db.transaction('meta', 'readwrite'); const store = tx.objectStore('meta'); store.put({ key: 'cats', val: STATE.cats }); store.put({ key: 'apCats', val: STATE.apCats }); store.put({ key: 'subs', val: STATE.subs }); store.put({ key: 'products', val: STATE.products }); }

        // --- DASHBOARD TIME MACHINE ---
        function updateDashboardDate(dateStr) { if(!dateStr) return; DASHBOARD_TARGET_DATE = dateStr; renderMetrics(); document.getElementById('current-system-date').innerText = (dateStr === TODAY_STR) ? TODAY_STR : dateStr; }
        
        // --- SMART FORMATTING ---
        function formatSmartNumber(num) { if (Math.abs(num) < 10000) return new Intl.NumberFormat('en-US').format(num); if (Math.abs(num) < 100000000) return (num / 10000).toFixed(2) + '萬'; return (num / 100000000).toFixed(2) + '億'; }
        function showToast(msg) { const box = document.getElementById('toast-box'); box.innerText = msg; box.classList.add('show'); setTimeout(() => box.classList.remove('show'), 3000); }

        // --- SMART ENTRY ---
        function openSmartEntry() {
            document.getElementById('modal-smart-entry').classList.remove('hidden');
            const pSel = document.getElementById('sm-product'); pSel.innerHTML = '<option value="">-- 選擇商品 --</option>';
            STATE.products.forEach(p => { const o = document.createElement('option'); o.value = p.name; o.text = p.name; o.dataset.price = p.price; o.dataset.cost = p.cost || 0; pSel.add(o); });
            const cSel = document.getElementById('sm-cat'); cSel.innerHTML = ''; STATE.cats.forEach(c => { const o = document.createElement('option'); o.value=c; o.text=c; cSel.add(o); });
            
            // LOCK LOGIC FIX
            if(SMART_DATE_LOCK && SMART_LOCKED_DATE) document.getElementById('sm-date').value = SMART_LOCKED_DATE;
            else document.getElementById('sm-date').value = TODAY_STR;
            updateLockUI();
        }
        function closeSmartEntry() { document.getElementById('modal-smart-entry').classList.add('hidden'); }
        function toggleSmartLock() { 
            SMART_DATE_LOCK = !SMART_DATE_LOCK; 
            if(SMART_DATE_LOCK) SMART_LOCKED_DATE = document.getElementById('sm-date').value; 
            updateLockUI(); 
        }
        function updateLockUI() { const btn = document.getElementById('btn-smart-lock'); if(SMART_DATE_LOCK) { btn.innerHTML = '<i class="fas fa-lock"></i>'; btn.classList.remove('text-red-200'); btn.classList.add('text-white'); } else { btn.innerHTML = '<i class="fas fa-lock-open"></i>'; btn.classList.add('text-red-200'); btn.classList.remove('text-white'); } }
        function onProductSelect() { const sel = document.getElementById('sm-product'); const opt = sel.options[sel.selectedIndex]; if (opt.dataset.price) document.getElementById('sm-price').value = opt.dataset.price; calcTotal(); }
        function syncWeight(source) { const kgIn = document.getElementById('sm-kg'), jinIn = document.getElementById('sm-jin'); if (source === 'kg') { const val = parseFloat(kgIn.value); jinIn.value = isNaN(val) ? '' : (val * 2).toFixed(2); } else { const val = parseFloat(jinIn.value); kgIn.value = isNaN(val) ? '' : (val / 2).toFixed(2); } calcTotal(); }
        function calcTotal() { const jin = parseFloat(document.getElementById('sm-jin').value), price = parseFloat(document.getElementById('sm-price').value), totalIn = document.getElementById('sm-total'); if (!isNaN(jin) && !isNaN(price)) totalIn.value = (jin * price).toFixed(2); else totalIn.value = '0.00'; }
        async function commitSmartData() {
            const prod = document.getElementById('sm-product').value; const sel = document.getElementById('sm-product'), opt = sel.options[sel.selectedIndex]; const costPerJin = parseFloat(opt.dataset.cost) || 0; const jin = parseFloat(document.getElementById('sm-jin').value), amt = parseFloat(document.getElementById('sm-total').value); const cat = document.getElementById('sm-cat').value, type = document.getElementById('sm-type').value, date = document.getElementById('sm-date').value;
            if (!prod || !amt || !date) { alert('請完整填寫資訊'); return; }
            const salesTx = { id: Date.now().toString(36), ts: Date.now(), date, type, cat, sub: `${prod}${jin}斤`, amt, isPaid: false }; await saveTx(salesTx);
            if (costPerJin > 0 && jin > 0 && (type === 'income' || type === 'credit')) { const totalCost = parseFloat((jin * costPerJin).toFixed(2)); const costTx = { id: Date.now().toString(36) + '_c', ts: Date.now(), date, type: 'cost', cat, sub: `[成本]${prod}${jin}斤`, amt: totalCost }; await saveTx(costTx); }
            if(SMART_DATE_LOCK) SMART_LOCKED_DATE = date; 
            closeSmartEntry(); renderHome();
        }

        // --- DATE EDITING ---
        let editTargetId = null;
        function promptEditDate(id, current) { editTargetId = id; document.getElementById('edit-date-input').value = current; document.getElementById('modal-date-edit').classList.remove('hidden'); }
        async function commitDateEdit() { const newDate = document.getElementById('edit-date-input').value; if(!newDate) return; const txItem = STATE.txs.find(t => t.id === editTargetId); if(txItem) { txItem.date = newDate; await saveTx(txItem); document.getElementById('modal-date-edit').classList.add('hidden'); refreshAllViews(); } }

        // --- RENAME & SYNC (DUAL TRACK FIXED + COST FIX + RELOAD) ---
        function promptRenameCat(oldName) { const newName = prompt(`將分類「${oldName}」改名為：`, oldName); if(newName && newName !== oldName) { actionType = 'renameCat'; targetOldName = oldName; targetNewName = newName; openAlert('確認改名', `確定將「${oldName}」全部改為「${newName}」？`, '系統將後台同步更新所有歷史數據。'); } }
        function promptRenameApCat(oldName) { const newName = prompt(`將「${oldName}」改名為：`, oldName); if(newName && newName !== oldName) { actionType = 'renameApCat'; targetOldName = oldName; targetNewName = newName; openAlert('確認改名', `確定將「${oldName}」全部改為「${newName}」？`, '系統將後台同步更新所有歷史數據。'); } }
        function promptRenameProd(oldName) { const newName = prompt(`將商品「${oldName}」改名為：`, oldName); if(newName && newName !== oldName) { actionType = 'renameProd'; targetOldName = oldName; targetNewName = newName; openAlert('確認改名', `確定將「${oldName}」全部改為「${newName}」？`, '這會更新歷史帳務中所有以該商品開頭的項目。'); } }

        async function executeBatchRename(pType, pOld, pNew) {
            updateMetaAfterRename(pType, pOld, pNew); 
            updateMemoryTxsInstant(pType, pOld, pNew); 
            refreshAllViews(); 
            
            IS_RENAMING = true;
            renameCount = 0;
            updateStatusUI(); 
            
            const tx = db.transaction('txs', 'readwrite');
            const store = tx.objectStore('txs');
            
            const countReq = store.count();
            countReq.onsuccess = () => {
                renameTotal = countReq.result;
                const cursorReq = store.openCursor();
                cursorReq.onsuccess = (e) => {
                    const cursor = e.target.result;
                    if (cursor) {
                        const t = cursor.value;
                        let updated = false;
                        
                        if (pType === 'renameCat' && t.cat === pOld) { t.cat = pNew; updated = true; }
                        else if (pType === 'renameApCat' && t.cat === pOld && t.type === 'accounts_payable') { t.cat = pNew; updated = true; }
                        else if (pType === 'renameProd') {
                             // Full logic fix: Check normal name OR cost name
                             if (t.sub.startsWith(pOld)) { t.sub = t.sub.replace(pOld, pNew); updated = true; }
                             else if (t.sub.startsWith('[成本]' + pOld) || t.sub.startsWith('[成本] ' + pOld)) { t.sub = t.sub.replace(pOld, pNew); updated = true; }
                        }
                        
                        if (updated) { cursor.update(t); }
                        
                        renameCount++;
                        if (renameCount % Math.floor(renameTotal / 20) === 0) {
                            showToast(`同步中: ${Math.floor((renameCount/renameTotal)*100)}%...`);
                        }
                        cursor.continue();
                    } else {
                        // DONE & RELOAD
                        IS_RENAMING = false;
                        updateStatusUI(); 
                        alert('同步完成！頁面將自動重整以應用變更。'); // Alert before reload
                        location.reload(); // Forced Reload
                    }
                };
            };
        }

        function updateMemoryTxsInstant(type, oldN, newN) {
            STATE.txs.forEach(t => {
                if (type === 'renameCat' && t.cat === oldN) t.cat = newN;
                else if (type === 'renameApCat' && t.cat === oldN && t.type === 'accounts_payable') t.cat = newN;
                else if (type === 'renameProd') {
                    if (t.sub.startsWith(oldN)) t.sub = t.sub.replace(oldN, newN);
                    else if (t.sub.startsWith('[成本]' + oldN) || t.sub.startsWith('[成本] ' + oldN)) t.sub = t.sub.replace(oldN, newN);
                }
            });
        }

        function updateMetaAfterRename(type, oldN, newN) {
            if (type === 'renameCat') { const idx = STATE.cats.indexOf(oldN); if(idx !== -1) STATE.cats[idx] = newN; } 
            else if (type === 'renameApCat') { const idx = STATE.apCats.indexOf(oldN); if(idx !== -1) STATE.apCats[idx] = newN; } 
            else if (type === 'renameProd') { const p = STATE.products.find(x => x.name === oldN); if(p) p.name = newN; }
            saveMeta();
        }

        // --- APP LOGIC ---
        window.onload = () => { 
            document.getElementById('in-date').value = TODAY_STR; 
            document.getElementById('crm-date-start').value = TODAY_STR; document.getElementById('crm-date-end').value = TODAY_STR;
            document.getElementById('apm-date-start').value = TODAY_STR; document.getElementById('apm-date-end').value = TODAY_STR;
            document.getElementById('exp-date-start').value = TODAY_STR; document.getElementById('exp-date-end').value = TODAY_STR; 
            document.getElementById('qry-date-start').value = TODAY_STR; document.getElementById('qry-date-end').value = TODAY_STR;
            document.getElementById('current-system-date').innerText = TODAY_STR; 
            initSystem(); 
        };
        function toggleSidebar() { const sb = document.getElementById('sidebar'), ov = document.getElementById('sidebar-overlay'); if(!sb.classList.contains('-translate-x-full')){ sb.classList.add('-translate-x-full'); ov.classList.add('hidden'); } else{ sb.classList.remove('-translate-x-full'); ov.classList.remove('hidden'); } }
        function route(v) {
            document.querySelectorAll('.nav-item').forEach(e=>e.classList.remove('active')); document.getElementById(`nav-${v}`).classList.add('active');
            ['home','credit','payable','expense','query','config'].forEach(id => document.getElementById(`view-${id}`).classList.add('hidden')); 
            document.getElementById(`view-${v}`).classList.remove('hidden');
            document.getElementById('page-title').innerText = {'home':'系統控制台 (CONSOLE)','credit':'賒帳管理 (CREDIT)','payable':'賒購分析 (AP)','expense':'費用管理 (EXPENSE)','query':'商業分析 (BI)','config':'系統配置 (CONFIG)'}[v]; 
            toggleSidebar(); if(v==='home') renderHome();
            if(v==='credit') { renderQueryCats('crm-cat-filter'); toggleCreditDateInputs(); renderCreditManager(); }
            if(v==='payable') { renderPayableQueryCats('apm-cat-filter'); togglePayableDateInputs(); renderPayableManager(); } 
            if(v==='expense') { renderQueryCats('exp-cat-filter'); toggleExpenseDateInputs(); renderExpenseManager(); } 
            if(v==='query') { renderQueryCats('qry-cat'); toggleQueryDateInputs(); runQuery(); }
            if(v==='config') { renderCatManager(); renderApCatManager(); renderProdManager(); }
        }
        function setType(t) { STATE.currType = t; document.querySelectorAll('.type-btn').forEach(b => b.classList.toggle('active', b.dataset.type === t)); renderCats(); }
        async function commitData(e) {
            e.preventDefault();
            const amt = parseFloat(document.getElementById('in-amt').value), date = document.getElementById('in-date').value, cat = document.getElementById('in-cat').value, sub = document.getElementById('in-sub').value.trim() || '一般項目';
            if(!amt || !date) return;
            let entry = STATE.subs.find(s => s.cat === cat);
            if(!entry) { entry = { cat, items: [] }; STATE.subs.push(entry); } if(!entry.items.includes(sub)) entry.items.push(sub); saveMeta(); 
            const newTx = { id: Date.now().toString(36), ts: Date.now(), date, type: STATE.currType, cat, sub, amt, isPaid: false };
            await saveTx(newTx);
            document.getElementById('in-amt').value = ''; document.getElementById('in-sub').value = ''; document.getElementById('in-amt').focus(); renderHome();
        }

        // --- METRICS ---
        function renderMetrics() {
            let dCash=0, dCredit=0, dCost=0, dExp=0; let aCash=0, aCredit=0, aCost=0, aExp=0, aOut=0;
            const dayRevStores = new Set(); const dayCredStores = new Set();
            const globalContainer = document.getElementById('global-metrics-container'), globalContent = document.getElementById('global-metrics-content');
            if (!IS_FULL_LOADED) { globalContainer.classList.remove('hidden'); globalContent.classList.add('hidden'); } else { globalContainer.classList.add('hidden'); globalContent.classList.remove('hidden'); }
            STATE.txs.forEach(t => {
                if (t.type === 'accounts_payable' || t.type === 'paid_ap') return; 
                if(t.date === DASHBOARD_TARGET_DATE) {
                    let type = (t.type==='debt'||t.type==='receivable')?'credit':t.type;
                    if(type === 'income') { dCash += t.amt; dayRevStores.add(t.cat); } else if(type === 'credit') { dCredit += t.amt; dayCredStores.add(t.cat); } else if(type === 'cost') dCost += t.amt; else if(type === 'expense') dExp += t.amt;
                }
                if (IS_FULL_LOADED) {
                    let type = (t.type==='debt'||t.type==='receivable')?'credit':t.type;
                    if(type === 'income') aCash += t.amt; else if(type === 'credit') { aCredit += t.amt; if(!t.isPaid) aOut += t.amt; } else if(type === 'cost') aCost += t.amt; else if(type === 'expense') aExp += t.amt;
                }
            });
            const fmt = new Intl.NumberFormat('en-US');
            const dRev = dCash + dCredit; const dGP = dRev - dCost; const dMargin = dRev > 0 ? (dGP / dRev) * 100 : 0; const dNet = dGP - dExp;
            document.getElementById('day-rev').innerText = formatSmartNumber(dRev); document.getElementById('day-rev').onclick = () => showToast(fmt.format(dRev));
            document.getElementById('day-rev-count').innerText = `(${dayRevStores.size})`;
            document.getElementById('day-credit').innerText = formatSmartNumber(dCredit); document.getElementById('day-credit').onclick = () => showToast(fmt.format(dCredit));
            document.getElementById('day-credit-count').innerText = `(${dayCredStores.size})`;
            document.getElementById('day-margin').innerText = dMargin.toFixed(1) + '%';
            document.getElementById('day-cost').innerText = formatSmartNumber(dCost); document.getElementById('day-cost').onclick = () => showToast(fmt.format(dCost));
            document.getElementById('day-exp').innerText = formatSmartNumber(dExp); document.getElementById('day-exp').onclick = () => showToast(fmt.format(dExp));
            document.getElementById('day-net').innerText = formatSmartNumber(dNet); document.getElementById('day-net').onclick = () => showToast(fmt.format(dNet));
            if (IS_FULL_LOADED) {
                const aRev = aCash + aCredit; const aGP = aRev - aCost; const aMargin = aRev > 0 ? (aGP / aRev) * 100 : 0; 
                document.getElementById('all-rev').innerText = formatSmartNumber(aRev); document.getElementById('all-rev').onclick = () => showToast(fmt.format(aRev));
                document.getElementById('all-outstanding').innerText = formatSmartNumber(aOut); document.getElementById('all-outstanding').onclick = () => showToast(fmt.format(aOut));
                document.getElementById('all-margin').innerText = aMargin.toFixed(1) + '%';
            }
        }

        // --- RENDER HELPERS ---
        function renderGeneric2Level(mode, catFilter, dataList, containerId, headerId, rowRenderer, drillDownCallback, keyword = "") {
            const container = document.getElementById(containerId); const header = document.getElementById(headerId); container.innerHTML = '';
            if (catFilter === 'all' && !keyword) {
                header.classList.add('hidden');
                const summary = {};
                dataList.forEach(t => { if (!summary[t.cat]) summary[t.cat] = { amt: 0, count: 0 }; summary[t.cat].amt += t.amt; summary[t.cat].count++; });
                if (Object.keys(summary).length === 0) { container.innerHTML = '<div class="text-center py-10 text-gray-300 text-xs font-mono">該期間無紀錄</div>'; return; }
                Object.keys(summary).forEach(cat => {
                    const card = document.createElement('div'); card.className = 'summary-card';
                    card.innerHTML = `<div><div class="store-name">${cat}</div><div class="store-count">${summary[cat].count} 筆紀錄</div></div><div class="store-amt" onclick="event.stopPropagation(); showToast('${new Intl.NumberFormat('en-US').format(summary[cat].amt)}')">${formatSmartNumber(summary[cat].amt)}</div>`;
                    card.onclick = () => drillDownCallback(cat); container.appendChild(card);
                });
            } else {
                header.classList.remove('hidden');
                const P = (mode === 'query') ? QUERY_PAGINATION : (mode === 'payable' ? PAYABLE_PAGINATION : (mode === 'expense' ? EXPENSE_PAGINATION : CREDIT_PAGINATION));
                P.currentData = dataList; P.totalResults = dataList.length; P.totalPages = Math.ceil(dataList.length / P.pageSize);
                const start = (P.currentPage - 1) * P.pageSize; const end = start + P.pageSize; const paginatedData = dataList.slice(start, end);
                if (paginatedData.length === 0) { container.innerHTML = '<div class="text-center py-10 text-gray-300 text-xs font-mono">無符合紀錄</div>'; } 
                else { paginatedData.forEach(t => container.appendChild(rowRenderer(t))); }
                document.getElementById(`${mode}-page-info`).innerText = `Page ${P.currentPage} / ${P.totalPages} (Total ${P.totalResults})`;
                document.getElementById(`${mode}-btn-prev`).disabled = (P.currentPage <= 1); document.getElementById(`${mode}-btn-next`).disabled = (P.currentPage >= P.totalPages);
            }
        }

        // --- EXPENSE MANAGER ---
        function renderExpenseManager(resetPage = true) {
            const mode = document.getElementById('exp-time-mode').value, catFilter = document.getElementById('exp-cat-filter').value;
            const startDate = document.getElementById('exp-date-start').value, endDate = document.getElementById('exp-date-end').value;
            document.getElementById('exp-period-label').innerText = (mode === 'day') ? startDate : ((mode === 'range') ? `${startDate} ~ ${endDate}` : "ALL TIME");
            
            let allExpenses = STATE.txs.filter(t => t.type === 'expense');
            let globalTotal = 0; allExpenses.forEach(t => globalTotal += t.amt);
            document.getElementById('exp-global-total').innerText = formatSmartNumber(globalTotal); document.getElementById('exp-global-total').onclick = () => showToast(globalTotal);
            const dateFiltered = allExpenses.filter(t => { if (mode === 'day') return t.date === startDate; if (mode === 'range') return t.date >= startDate && t.date <= endDate; return true; });
            let periodTotal=0; dateFiltered.forEach(t => periodTotal += t.amt);
            document.getElementById('exp-period-total').innerText = formatSmartNumber(periodTotal); document.getElementById('exp-period-total').onclick = () => showToast(periodTotal);
            let finalData = dateFiltered; if (catFilter !== 'all') finalData = finalData.filter(t => t.cat === catFilter);
            if (resetPage) EXPENSE_PAGINATION.currentPage = 1;
            renderGeneric2Level('expense', catFilter, finalData, 'expense-list', 'exp-list-header', (t) => {
                const row = document.createElement('div'); row.className = 'row-expense';
                row.innerHTML = `<div class="num-font text-xs text-gray-500 pl-1 date-cell" onclick="promptEditDate('${t.id}', '${t.date}')">${t.date}</div><div class="text-info truncate"><div class="font-bold text-xs truncate">${t.sub}</div><div class="text-[0.6rem] text-gray-400 font-mono uppercase">${t.cat}</div></div><div class="text-right num-font font-bold text-xs text-rose-600" onclick="showToast('${t.amt}')">${formatSmartNumber(t.amt)}</div><div class="text-center"><div onclick="promptDeleteTx('${t.id}')" class="btn-delete" role="button"><i class="fas fa-times"></i></div></div>`;
                return row;
            }, (cat) => { document.getElementById('exp-cat-filter').value = cat; renderExpenseManager(); });
        }
        function toggleExpenseDateInputs() { const mode = document.getElementById('exp-time-mode').value; if (mode === 'day') { document.getElementById('exp-date-start').classList.remove('hidden'); document.getElementById('exp-date-end').classList.add('hidden'); } else if (mode === 'range') { document.getElementById('exp-date-start').classList.remove('hidden'); document.getElementById('exp-date-end').classList.remove('hidden'); } else { document.getElementById('exp-date-start').classList.add('hidden'); document.getElementById('exp-date-end').classList.add('hidden'); } renderExpenseManager(); }

        // --- CREDIT MANAGER ---
        function renderCreditManager(resetPage = true) {
            const mode = document.getElementById('crm-time-mode').value, catFilter = document.getElementById('crm-cat-filter').value;
            const startDate = document.getElementById('crm-date-start').value, endDate = document.getElementById('crm-date-end').value;
            document.getElementById('crm-period-label').innerText = (mode === 'day') ? startDate : ((mode === 'range') ? `${startDate} ~ ${endDate}` : "ALL TIME");
            let allCredits = STATE.txs.filter(t => (t.type === 'credit' || t.type === 'receivable' || t.type === 'debt'));
            const dateFiltered = allCredits.filter(t => { if (mode === 'day') return t.date === startDate; if (mode === 'range') return t.date >= startDate && t.date <= endDate; return true; });
            let periodIssued=0, periodOutstanding=0; dateFiltered.forEach(t => { periodIssued += t.amt; periodOutstanding += t.amt; });
            document.getElementById('crm-period-issued').innerText = formatSmartNumber(periodIssued); document.getElementById('crm-period-issued').onclick = () => showToast(periodIssued);
            document.getElementById('crm-period-outstanding').innerText = formatSmartNumber(periodOutstanding); document.getElementById('crm-period-outstanding').onclick = () => showToast(periodOutstanding);
            let totalIssued=0, totalOutstanding=0; allCredits.forEach(t => { totalIssued += t.amt; totalOutstanding += t.amt; });
            document.getElementById('crm-total-issued').innerText = formatSmartNumber(totalIssued); document.getElementById('crm-total-issued').onclick = () => showToast(totalIssued);
            document.getElementById('crm-total-outstanding').innerText = formatSmartNumber(totalOutstanding); document.getElementById('crm-total-outstanding').onclick = () => showToast(totalOutstanding);
            let finalData = dateFiltered; if (catFilter !== 'all') finalData = finalData.filter(t => t.cat === catFilter);
            if (resetPage) CREDIT_PAGINATION.currentPage = 1;
            renderGeneric2Level('credit', catFilter, finalData, 'credit-list', 'crm-list-header', (t) => {
                const row = document.createElement('div'); row.className = 'row-credit';
                row.innerHTML = `<div class="flex justify-center"><button onclick="promptSettle('${t.id}')" class="btn-settle" title="結清"><i class="fas fa-check text-xs"></i></button></div><div class="num-font text-xs text-gray-500 date-cell" onclick="promptEditDate('${t.id}', '${t.date}')">${t.date}</div><div class="text-info truncate"><div class="font-bold text-xs truncate">${t.sub}</div><div class="text-[0.6rem] text-gray-400 font-mono uppercase">${t.cat}</div></div><div class="text-right num-font font-bold text-xs text-amt text-amber-600" onclick="showToast('${t.amt}')">${formatSmartNumber(t.amt)}</div>`;
                return row;
            }, (cat) => { document.getElementById('crm-cat-filter').value = cat; renderCreditManager(); });
        }
        function toggleCreditDateInputs() { const mode = document.getElementById('crm-time-mode').value; if (mode === 'day') { document.getElementById('crm-date-start').classList.remove('hidden'); document.getElementById('crm-date-end').classList.add('hidden'); } else if (mode === 'range') { document.getElementById('crm-date-start').classList.remove('hidden'); document.getElementById('crm-date-end').classList.remove('hidden'); } else { document.getElementById('crm-date-start').classList.add('hidden'); document.getElementById('crm-date-end').classList.add('hidden'); } renderCreditManager(); }

        // --- PAYABLE MANAGER ---
        function renderPayableManager(resetPage = true) {
            const mode = document.getElementById('apm-time-mode').value, catFilter = document.getElementById('apm-cat-filter').value;
            const startDate = document.getElementById('apm-date-start').value, endDate = document.getElementById('apm-date-end').value;
            document.getElementById('apm-period-label').innerText = (mode === 'day') ? startDate : ((mode === 'range') ? `${startDate} ~ ${endDate}` : "ALL TIME");
            let allPayables = STATE.txs.filter(t => t.type === 'accounts_payable');
            const dateFiltered = allPayables.filter(t => { if (mode === 'day') return t.date === startDate; if (mode === 'range') return t.date >= startDate && t.date <= endDate; return true; });
            let periodIssued=0, periodOutstanding=0; dateFiltered.forEach(t => { periodIssued += t.amt; periodOutstanding += t.amt; });
            document.getElementById('apm-period-issued').innerText = formatSmartNumber(periodIssued); document.getElementById('apm-period-issued').onclick = () => showToast(periodIssued);
            document.getElementById('apm-period-outstanding').innerText = formatSmartNumber(periodOutstanding); document.getElementById('apm-period-outstanding').onclick = () => showToast(periodOutstanding);
            let totalIssued=0, totalOutstanding=0; allPayables.forEach(t => { totalIssued += t.amt; totalOutstanding += t.amt; });
            document.getElementById('apm-total-issued').innerText = formatSmartNumber(totalIssued); document.getElementById('apm-total-issued').onclick = () => showToast(totalIssued);
            document.getElementById('apm-total-outstanding').innerText = formatSmartNumber(totalOutstanding); document.getElementById('apm-total-outstanding').onclick = () => showToast(totalOutstanding);
            let finalData = dateFiltered; if (catFilter !== 'all') finalData = finalData.filter(t => t.cat === catFilter);
            if (resetPage) PAYABLE_PAGINATION.currentPage = 1;
            renderGeneric2Level('payable', catFilter, finalData, 'payable-list', 'apm-list-header', (t) => {
                const row = document.createElement('div'); row.className = 'row-payable';
                row.innerHTML = `<div class="flex justify-center"><button onclick="promptPay('${t.id}')" class="btn-settle bg-blue-50 hover:border-blue-700 hover:text-blue-700 active:bg-blue-700 active:text-white"><i class="fas fa-check text-xs"></i></button></div><div class="num-font text-xs text-gray-500 date-cell" onclick="promptEditDate('${t.id}', '${t.date}')">${t.date}</div><div class="text-info truncate"><div class="font-bold text-xs truncate">${t.sub}</div><div class="text-[0.6rem] text-gray-400 font-mono uppercase">${t.cat}</div></div><div class="text-right num-font font-bold text-xs text-amt text-blue-600" onclick="showToast('${t.amt}')">${formatSmartNumber(t.amt)}</div>`;
                return row;
            }, (cat) => { document.getElementById('apm-cat-filter').value = cat; renderPayableManager(); });
        }
        function togglePayableDateInputs() { const mode = document.getElementById('apm-time-mode').value; if (mode === 'day') { document.getElementById('apm-date-start').classList.remove('hidden'); document.getElementById('apm-date-end').classList.add('hidden'); } else if (mode === 'range') { document.getElementById('apm-date-start').classList.remove('hidden'); document.getElementById('apm-date-end').classList.remove('hidden'); } else { document.getElementById('apm-date-start').classList.add('hidden'); document.getElementById('apm-date-end').classList.add('hidden'); } renderPayableManager(); }

        // --- QUERY SYSTEM (BI FIXED) ---
        function runQuery(resetPage = true) {
            const tm = document.getElementById('qry-time-mode').value, kw = document.getElementById('qry-keyword').value.trim().toLowerCase(), cat = document.getElementById('qry-cat').value;
            const now = new Date(); let s, e;
            if(tm==='month'){s=new Date(now.getFullYear(),now.getMonth(),1);e=new Date(now.getFullYear(),now.getMonth()+1,0);}
            else if(tm==='year'){s=new Date(now.getFullYear(),0,1);e=new Date(now.getFullYear(),11,31);}
            else if(tm==='day') { const d=document.getElementById('qry-date-start').value; if(d){s=new Date(d);e=new Date(d);} }
            else if(tm==='range') { const d1=document.getElementById('qry-date-start').value; const d2=document.getElementById('qry-date-end').value; if(d1)s=new Date(d1); if(d2)e=new Date(d2); }
            document.getElementById('qry-period-label').innerText = (s&&e) ? ((s.getTime()===e.getTime())?s.toISOString().split('T')[0]:`${s.toISOString().split('T')[0]}~${e.toISOString().split('T')[0]}`) : "ALL TIME";
            let res = STATE.txs.filter(t => {
                if (t.type === 'accounts_payable' || t.type === 'paid_ap') return false; 
                if(tm!=='all' && s && e) { const d=new Date(t.date); if(d<s || d>e) return false; }
                return true;
            });
            if(cat !== 'all') res = res.filter(t => t.cat === cat);
            if(kw) { res = res.filter(t => t.sub.toLowerCase().includes(kw) || t.cat.toLowerCase().includes(kw)); }
            renderQueryMetrics(res);
            if (resetPage) QUERY_PAGINATION.currentPage = 1;
            let listRes = res.filter(t => t.type !== 'expense');
            renderGeneric2Level('query', cat, listRes, 'query-list', 'qry-list-header', (t) => createRow(t), (cat) => { document.getElementById('qry-cat').value = cat; runQuery(); }, kw);
        }
        function renderQueryMetrics(data) {
            let cash=0, credit=0, cost=0, exp=0, volume=0;
            data.forEach(t => {
                if (t.type === 'accounts_payable' || t.type === 'paid_ap') return; 
                let tp = (t.type==='debt'||t.type==='receivable')?'credit':t.type;
                if(tp==='income') cash+=t.amt; else if(tp==='credit') credit+=t.amt; else if(tp==='cost') cost+=t.amt; else if(tp==='expense') exp+=t.amt;
                if (t.type !== 'cost' && t.type !== 'expense') { const match = t.sub.match(/(\d+(\.\d+)?)\s*斤/); if (match) volume += parseFloat(match[1]); }
            });
            const rev = cash + credit; const gp = rev - cost; const m = rev>0?(gp/rev)*100:0; const net = gp - exp;
            document.getElementById('res-rev').innerText = formatSmartNumber(rev); document.getElementById('res-rev').onclick = () => showToast(rev);
            document.getElementById('res-cost').innerText = formatSmartNumber(cost); document.getElementById('res-cost').onclick = () => showToast(cost);
            document.getElementById('res-exp').innerText = formatSmartNumber(exp); document.getElementById('res-exp').onclick = () => showToast(exp);
            document.getElementById('res-gp').innerText = formatSmartNumber(gp); document.getElementById('res-gp').onclick = () => showToast(gp);
            document.getElementById('res-margin').innerText = m.toFixed(1)+'%';
            document.getElementById('res-net').innerText = formatSmartNumber(net); document.getElementById('res-net').onclick = () => showToast(net);
            document.getElementById('res-count').innerText = data.length;
            document.getElementById('res-volume').innerText = formatSmartNumber(volume); document.getElementById('res-volume').onclick = () => showToast(volume);
        }
        function toggleQueryDateInputs() { const mode = document.getElementById('qry-time-mode').value; const inputs = document.getElementById('qry-date-inputs'); if (mode === 'day' || mode === 'range') { inputs.classList.remove('hidden'); if(mode === 'range') document.getElementById('qry-date-end').classList.remove('hidden'); else document.getElementById('qry-date-end').classList.add('hidden'); } else { inputs.classList.add('hidden'); } runQuery(); }

        // --- SHARED UI ---
        function renderHome() { renderCats(); renderLedgerList(); renderMetrics(); updateSubSuggest(); }
        function renderLedgerList() {
            const list = document.getElementById('home-ledger-list'); list.innerHTML = '';
            const data = STATE.txs.slice(0, 100); 
            if(!data.length) { list.innerHTML = '<div class="text-center py-10 text-gray-300 text-xs font-mono">暫無數據</div>'; return; }
            data.forEach(t => list.appendChild(createRow(t)));
        }
        function createRow(t) {
            const row = document.createElement('div'); row.className = 'row-item hover:bg-gray-50 transition-colors';
            let color='text-gray-900', sign='', type=(t.type==='debt'||t.type==='receivable')?'credit':t.type;
            if(t.type === 'accounts_payable') { color='text-blue-600'; sign='+'; } else if(t.type === 'paid_ap') { color='text-gray-400 line-through'; sign='='; } else if(type==='income'){color='text-emerald-700';sign='+';} else if(type==='credit'){color='text-amber-700';sign='+';} else if(type==='cost'){color='text-orange-700';sign='-';} else if(type==='expense'){color='text-rose-700';sign='-';}
            row.innerHTML = `<div class="num-font text-xs text-gray-500 pl-1 date-cell" onclick="promptEditDate('${t.id}', '${t.date}')">${t.date}</div><div class="truncate"><div class="font-bold text-gray-900 text-xs truncate">${t.sub}</div><div class="text-[0.6rem] text-gray-400 font-mono uppercase bg-gray-100 px-1 rounded-sm inline-block mt-0.5">${t.cat}</div></div><div class="text-right num-font font-bold text-xs ${color}" onclick="showToast('${t.amt}')">${formatSmartNumber(t.amt)}</div><div class="text-center flex justify-center"><div onclick="promptDeleteTx('${t.id}')" class="btn-delete" role="button"><i class="fas fa-times"></i></div></div>`;
            return row;
        }
        function renderCats() { 
            const s=document.getElementById('in-cat'); const v=s.value; s.innerHTML=''; 
            let categories = (STATE.currType === 'accounts_payable') ? STATE.apCats : STATE.cats;
            categories.forEach(c=>{const o=document.createElement('option');o.value=c;o.text=c;s.add(o)}); if(categories.includes(v))s.value=v; updateSubSuggest(); 
        }
        function renderQueryCats(id) { const s=document.getElementById(id); const v=s.value; s.innerHTML='<option value="all">-- 所有店鋪 (總覽) --</option>'; STATE.cats.forEach(c=>{const o=document.createElement('option');o.value=c;o.text=c;s.add(o)}); s.value=v; }
        function renderPayableQueryCats(id) { const s=document.getElementById(id); const v=s.value; s.innerHTML='<option value="all">-- 所有分類 (總覽) --</option>'; STATE.apCats.forEach(c=>{const o=document.createElement('option');o.value=c;o.text=c;s.add(o)}); s.value=v; }
        function updateSubSuggest() { const c=document.getElementById('in-cat').value; const l=document.getElementById('sub-list'); l.innerHTML=''; const e=STATE.subs.find(x=>x.cat===c); if(e)e.items.forEach(i=>{const o=document.createElement('option');o.value=i;l.appendChild(o)}); }
        function renderCatManager() { const l=document.getElementById('cat-list'); l.innerHTML=''; STATE.cats.forEach(c=>{ const d=document.createElement('div'); d.className='flex justify-between items-center text-xs bg-gray-50 px-2 py-2 border-b border-gray-100'; const s = document.createElement('span'); s.innerText = c; const b = document.createElement('button'); b.type = 'button'; b.className = 'btn-config-del'; b.innerHTML = '<i class="fas fa-times"></i>'; b.onclick = function() { promptDelCat(c); }; const e = document.createElement('button'); e.type = 'button'; e.className = 'btn-edit'; e.innerHTML = '<i class="fas fa-pen"></i>'; e.onclick = function() { promptRenameCat(c); }; d.appendChild(s); const bg = document.createElement('div'); bg.className='flex'; bg.appendChild(e); bg.appendChild(b); d.appendChild(bg); l.appendChild(d); }); }
        function renderApCatManager() { const l=document.getElementById('ap-cat-list'); l.innerHTML=''; STATE.apCats.forEach(c=>{ const d=document.createElement('div'); d.className='flex justify-between items-center text-xs bg-gray-50 px-2 py-2 border-b border-gray-100'; const s = document.createElement('span'); s.innerText = c; const b = document.createElement('button'); b.type = 'button'; b.className = 'btn-config-del'; b.innerHTML = '<i class="fas fa-times"></i>'; b.onclick = function() { promptDelApCat(c); }; const e = document.createElement('button'); e.type = 'button'; e.className = 'btn-edit'; e.innerHTML = '<i class="fas fa-pen"></i>'; e.onclick = function() { promptRenameApCat(c); }; d.appendChild(s); const bg = document.createElement('div'); bg.className='flex'; bg.appendChild(e); bg.appendChild(b); d.appendChild(bg); l.appendChild(d); }); }
        function renderProdManager() { const l=document.getElementById('prod-list'); l.innerHTML=''; STATE.products.forEach(p=>{ const d=document.createElement('div'); d.className='flex justify-between items-center text-xs bg-gray-50 px-2 py-2 border-b border-gray-100'; const costDisplay = p.cost ? ` <span class="text-orange-500">| 成本 $${p.cost}/斤</span>` : ''; const s = document.createElement('span'); s.innerHTML = `<b>${p.name}</b> <span class="text-gray-400">($${p.price}/斤${costDisplay})</span>`; const b = document.createElement('button'); b.type = 'button'; b.className = 'btn-config-del'; b.innerHTML = '<i class="fas fa-times"></i>'; b.onclick = function() { promptDelProd(p.name); }; const e = document.createElement('button'); e.type = 'button'; e.className = 'btn-edit'; e.innerHTML = '<i class="fas fa-pen"></i>'; e.onclick = function() { promptRenameProd(p.name); }; d.appendChild(s); const bg = document.createElement('div'); bg.className='flex'; bg.appendChild(e); bg.appendChild(b); d.appendChild(bg); l.appendChild(d); }); }

        function sysAddCat() { const v=document.getElementById('new-cat').value.trim(); if(v&&!STATE.cats.includes(v)){ STATE.cats.push(v); saveMeta(); renderCatManager(); document.getElementById('new-cat').value=''; } }
        function sysAddApCat() { const v=document.getElementById('new-ap-cat').value.trim(); if(v&&!STATE.apCats.includes(v)){ STATE.apCats.push(v); saveMeta(); renderApCatManager(); document.getElementById('new-ap-cat').value=''; } }
        function sysAddProduct() { const n=document.getElementById('new-prod-name').value.trim(), p=parseFloat(document.getElementById('new-prod-price').value), c=parseFloat(document.getElementById('new-prod-cost').value); if(n && !isNaN(p)){ STATE.products.push({name: n, price: p, cost: isNaN(c) ? 0 : c}); saveMeta(); renderProdManager(); document.getElementById('new-prod-name').value=''; document.getElementById('new-prod-price').value=''; document.getElementById('new-prod-cost').value=''; } }
        async function sysExport() {
            if(!IS_FULL_LOADED) { alert('請等待系統數據完全讀取後再執行導出。'); return; }
            if (!confirm('確認導出系統全部數據？')) return;
            const filename = prompt('請輸入導出檔案名稱:', `SYSTEM_LEDGER_${TODAY_STR}`); if (!filename) return;
            const exportData = { txs: STATE.txs, cats: STATE.cats, apCats: STATE.apCats, subs: STATE.subs, products: STATE.products };
            const json = JSON.stringify(exportData, null, 2); downloadFile(json, `${filename.trim()}.json`);
        }
        function downloadFile(content, filename) { const blob = new Blob([content], {type: "application/json"}); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = filename; document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url); }
        async function sysImport(input) {
            const files = input.files; if (files.length === 0) return; if (!confirm(`確認導入並整合 ${files.length} 個檔案的數據？`)) { input.value = ''; return; }
            let importedTxs = [], combinedCats = [...STATE.cats], combinedApCats = [...STATE.apCats], combinedProds = [...STATE.products], combinedSubs = JSON.parse(JSON.stringify(STATE.subs)); 
            try {
                for (let file of files) {
                    const text = await file.text(), d = JSON.parse(text);
                    if (Array.isArray(d.txs)) d.txs.forEach(t => { if(t.id) importedTxs.push(t); });
                    if(d.cats) d.cats.forEach(c => { if(!combinedCats.includes(c)) combinedCats.push(c); });
                    if(d.apCats) d.apCats.forEach(c => { if(!combinedApCats.includes(c)) combinedApCats.push(c); });
                    if(d.products) d.products.forEach(p => { if(!combinedProds.find(x=>x.name===p.name)) combinedProds.push(p); });
                    if(d.subs) d.subs.forEach(s => { const ex = combinedSubs.find(cs => cs.cat === s.cat); if(ex) { s.items.forEach(i => { if(!ex.items.includes(i)) ex.items.push(i); }); } else combinedSubs.push(s); });
                }
            } catch(e) { console.error(e); alert('檔案讀取錯誤，請確認 JSON 格式正確。'); input.value = ''; return; }
            const tx = db.transaction(['txs', 'meta'], 'readwrite'), txStore = tx.objectStore('txs'), metaStore = tx.objectStore('meta');
            importedTxs.forEach(t => txStore.put(t)); metaStore.put({ key: 'cats', val: combinedCats }); metaStore.put({ key: 'apCats', val: combinedApCats }); metaStore.put({ key: 'products', val: combinedProds }); metaStore.put({ key: 'subs', val: combinedSubs });
            tx.oncomplete = () => { alert(`導入成功！共寫入 ${importedTxs.length} 筆數據。`); location.reload(); }; tx.onerror = (e) => { console.error(e); alert('寫入資料庫時發生錯誤。'); }; input.value = '';
        }
        function injectMockData(count = 1000) {
            if(!confirm(`這將產生 ${count} 筆測試數據寫入 IndexedDB，確定執行？`)) return;
            const types = ['income', 'cost', 'expense', 'credit', 'accounts_payable'], cats = STATE.cats, subs = ['白菜', '牛肉', '水電', '租金', '進貨'];
            const tx = db.transaction('txs', 'readwrite'), store = tx.objectStore('txs');
            for(let i=0; i<count; i++) {
                const dateObj = new Date(); dateObj.setDate(dateObj.getDate() - Math.floor(Math.random() * 365));
                const date = dateObj.toISOString().split('T')[0], type = types[Math.floor(Math.random() * types.length)];
                let cat = (type === 'accounts_payable') ? STATE.apCats[Math.floor(Math.random() * STATE.apCats.length)] : cats[Math.floor(Math.random() * cats.length)];
                const sub = subs[Math.floor(Math.random() * subs.length)], amt = Math.floor(Math.random() * 5000) + 100;
                store.put({ id: Math.random().toString(36).substr(2, 9), ts: Date.now() - Math.floor(Math.random()*10000000), date, type, cat, sub, amt, isPaid: type === 'credit' ? false : undefined });
            }
            tx.oncomplete = () => { alert(`已寫入 ${count} 筆測試數據！頁面將重整。`); location.reload(); };
        }
        async function injectMassiveData() {
            if(!confirm('即將寫入 500,000 筆數據。這可能需要 30-60 秒，請勿關閉視窗。確定執行？')) return;
            const total = 500000, batchSize = 5000;
            const types = ['income', 'cost', 'expense', 'credit', 'accounts_payable'], cats = STATE.cats, subs = ['白菜', '牛肉', '水電', '租金', '進貨'];
            let processed = 0;
            showToast('開始寫入大數據...');
            function generateBatch() {
                return new Promise((resolve, reject) => {
                    const tx = db.transaction('txs', 'readwrite'); const store = tx.objectStore('txs');
                    for(let i=0; i<batchSize; i++) {
                        const dateObj = new Date(); dateObj.setDate(dateObj.getDate() - Math.floor(Math.random() * 365));
                        const date = dateObj.toISOString().split('T')[0], type = types[Math.floor(Math.random() * types.length)];
                        let cat = (type === 'accounts_payable') ? STATE.apCats[Math.floor(Math.random() * STATE.apCats.length)] : cats[Math.floor(Math.random() * cats.length)];
                        const sub = subs[Math.floor(Math.random() * subs.length)], amt = Math.floor(Math.random() * 5000) + 100;
                        store.put({ id: Math.random().toString(36).substr(2, 9) + i + processed, ts: Date.now() - Math.floor(Math.random()*10000000), date, type, cat, sub, amt, isPaid: type === 'credit' ? false : undefined });
                    }
                    tx.oncomplete = () => resolve(); tx.onerror = (e) => reject(e);
                });
            }
            try {
                while(processed < total) { await generateBatch(); processed += batchSize; showToast(`寫入進度: ${Math.floor((processed/total)*100)}%`); }
                alert('50 萬筆數據注入完成！頁面將重整。'); location.reload();
            } catch(e) { console.error(e); alert('寫入失敗'); }
        }

        // --- ACTIONS ---
        function openAlert(title, msg, detail = null) { document.getElementById('alert-title').innerText = title; document.getElementById('alert-msg').innerText = msg; const d = document.getElementById('alert-detail'); if (detail) { d.innerHTML = detail; d.classList.remove('hidden'); } else { d.classList.add('hidden'); } document.getElementById('modal-alert').classList.remove('hidden'); }
        function closeAlert() { document.getElementById('modal-alert').classList.add('hidden'); actionType = null; targetId = null; targetCat = null; targetProd = null; targetRenameType = null; }
        function promptDeleteTx(id) { const t = STATE.txs.find(x => x.id === id); if (!t) return; actionType = 'deleteTx'; targetId = id; openAlert('刪除紀錄', '確認移除此筆資料？', `ID: ${id}<br>ITEM: ${t.sub} ($${t.amt})`); }
        function promptDelCat(cat) { actionType = 'deleteCat'; targetCat = cat; openAlert('刪除分類', `確認移除交易分類「${cat}」？`, '歷史帳務不會刪除，但選單將不再顯示。'); }
        function promptDelApCat(cat) { actionType = 'deleteApCat'; targetCat = cat; openAlert('刪除賒購分類', `確認移除賒購分類「${cat}」？`, '歷史帳務不會刪除，但選單將不再顯示。'); }
        function promptDelProd(name) { actionType = 'deleteProd'; targetProd = name; openAlert('刪除商品', `確認移除商品「${name}」？`, '這不會影響歷史帳務。'); }
        function sysPurge() { actionType = 'purge'; openAlert('重置系統', '警告：將永久刪除所有資料！', '此操作將刪除整個 IndexedDB 資料庫。'); }
        function promptPay(id) { const t = STATE.txs.find(x => x.id === id); if(!t) return; actionType = 'pay_ap'; targetId = id; openAlert('確認支付', '此操作將把「應付帳款」標記為「已支付」', `應付金額：$${t.amt}`); }
        function promptSettle(id) { const t = STATE.txs.find(x => x.id === id); if(!t) return; actionType = 'settle'; targetId = id; openAlert('確認結清', '此操作將把「賒帳」轉為「營收」', `轉入營收：$${t.amt}`); }
        
        async function confirmAction() {
            if (actionType === 'deleteTx' && targetId) { await deleteTxDB(targetId); refreshAllViews(); } 
            else if (actionType === 'deleteCat' && targetCat) { STATE.cats = STATE.cats.filter(c => c !== targetCat); saveMeta(); renderCatManager(); if(!document.getElementById('view-home').classList.contains('hidden')) renderCats(); } 
            else if (actionType === 'deleteApCat' && targetCat) { STATE.apCats = STATE.apCats.filter(c => c !== targetCat); saveMeta(); renderApCatManager(); if(!document.getElementById('view-home').classList.contains('hidden')) renderCats(); } 
            else if (actionType === 'deleteProd' && targetProd) { STATE.products = STATE.products.filter(p => p.name !== targetProd); saveMeta(); renderProdManager(); }
            else if (actionType === 'purge') { if(db) db.close(); const req = indexedDB.deleteDatabase(DB_NAME); req.onsuccess = () => location.reload(); req.onblocked = () => location.reload(); } 
            else if (actionType === 'settle' && targetId) { const t = STATE.txs.find(x => x.id === targetId); if(t) { t.type = 'income'; delete t.isPaid; await saveTx(t); refreshAllViews(); } } 
            else if (actionType === 'pay_ap' && targetId) { const t = STATE.txs.find(x => x.id === targetId); if(t) { t.type = 'paid_ap'; delete t.isPaid; await saveTx(t); refreshAllViews(); } }
            
            // RENAME ACTIONS
            else if (actionType === 'renameCat' || actionType === 'renameApCat' || actionType === 'renameProd') {
                const pType = actionType; const pOld = targetOldName; const pNew = targetNewName;
                closeAlert(); // Close alert first to show toast
                await executeBatchRename(pType, pOld, pNew);
                return;
            }
            closeAlert();
        }

        function refreshAllViews() {
            if(!document.getElementById('view-home').classList.contains('hidden')) renderHome(); if(!document.getElementById('view-query').classList.contains('hidden')) runQuery(false); if(!document.getElementById('view-credit').classList.contains('hidden')) renderCreditManager(false); if(!document.getElementById('view-payable').classList.contains('hidden')) renderPayableManager(false); if(!document.getElementById('view-expense').classList.contains('hidden')) renderExpenseManager(false);
        }
        function changePage(view, delta) {
            const P = view === 'query' ? QUERY_PAGINATION : (view === 'payable' ? PAYABLE_PAGINATION : (view === 'expense' ? EXPENSE_PAGINATION : CREDIT_PAGINATION));
            P.currentPage += delta;
            if (view === 'query') runQuery(false); if (view === 'payable') renderPayableManager(false); if (view === 'credit') renderCreditManager(false); if (view === 'expense') renderExpenseManager(false);
            const scrollAreaId = view === 'query' ? 'view-query' : (view === 'payable' ? 'view-payable' : (view === 'expense' ? 'view-expense' : 'view-credit'));
            document.getElementById(scrollAreaId).querySelector('.scroll-touch').scrollTo(0, 0);
        }
    </script>
</body>
</html>
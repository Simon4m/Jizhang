<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SYSTEM_LEDGER v10.4 // ABSOLUTE_LOCK</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        /* DESIGN SPECIFICATION v10.4 */
        :root {
            --font-sans: 'Inter', -apple-system, BlinkMacSystemFont, "Microsoft JhengHei", sans-serif;
            --font-mono: 'JetBrains Mono', monospace;
            --c-income: #059669; --c-expense: #DC2626; --c-credit: #D97706; --c-cost: #EA580C;
            --c-ap: #3B82F6; /* 應付帳款顏色 */
            --bg-body: #F3F4F6;
        }
        
        /* 核心修正：強制鎖死 Body，防止橡皮筋效果，模擬 App 行為 */
        body { 
            position: fixed; 
            inset: 0; 
            width: 100%; 
            height: 100%; 
            overflow: hidden;
            font-family: var(--font-sans); 
            background-color: var(--bg-body); 
            color: #111827;
        }

        .num-font { font-family: var(--font-mono); font-variant-numeric: tabular-nums; letter-spacing: -0.05em; }
        
        /* 滾動條優化 */
        .no-scrollbar::-webkit-scrollbar { display: none; } 
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        /* 關鍵：讓滾動區塊在 iOS 上滑動更順暢 */
        .scroll-touch { -webkit-overflow-scrolling: touch; }

        /* SIDEBAR */
        #sidebar { transition: transform 0.2s cubic-bezier(0.4, 0, 0.2, 1); }
        .nav-item { display: flex; align-items: center; padding: 1rem; border-bottom: 1px solid #1F2937; color: #D1D5DB; font-size: 0.85rem; font-weight: 600; cursor: pointer; transition: all 0.1s; }
        .nav-item:active, .nav-item.active { background-color: #374151; color: #FFFFFF; border-left: 4px solid #FFFFFF; }
        .nav-icon { width: 24px; text-align: center; margin-right: 12px; }

        /* GRID */
        .dash-grid-pro { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1px; background-color: #E5E7EB; border-bottom: 1px solid #E5E7EB; }
        .dash-grid-dual { display: grid; grid-template-columns: 1fr 1fr; gap: 1px; background-color: #E5E7EB; border-bottom: 1px solid #E5E7EB; }
        .dash-cell { background-color: #FFFFFF; padding: 0.5rem 0.25rem; text-align: center; display: flex; flex-direction: column; justify-content: center; height: 60px; }
        .dash-cell.secondary { background-color: #F9FAFB; }
        .dash-row-header { grid-column: 1 / -1; background-color: #F3F4F6; color: #4B5563; font-size: 0.65rem; font-weight: 700; padding: 0.25rem 0.5rem; border-bottom: 1px solid #E5E7EB; letter-spacing: 0.05em; }
        .label-xs { font-size: 0.6rem; color: #6B7280; font-weight: 600; margin-bottom: 2px; text-transform: uppercase; }
        .val-md { font-size: 0.9rem; font-weight: 700; }

        /* INPUTS */
        .sys-input { border: 1px solid #D1D5DB; border-radius: 0; padding: 0.5rem; font-size: 0.85rem; background: white; color: #111827; width: 100%; height: 32px; }
        .sys-input:focus { border-color: #111827; outline: none; }

        /* BUTTONS */
        .type-btn { background: #F3F4F6; color: #6B7280; border: 1px solid transparent; font-size: 0.75rem; font-weight: 600; padding: 0.5rem 0; }
        .type-btn.active { background: #FFFFFF; border-color: #D1D5DB; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
        .type-btn.active[data-type="cost"] { color: var(--c-cost); border-bottom: 3px solid var(--c-cost); }
        .type-btn.active[data-type="expense"] { color: var(--c-expense); border-bottom: 3px solid var(--c-expense); }
        .type-btn.active[data-type="income"] { color: var(--c-income); border-bottom: 3px solid var(--c-income); }
        .type-btn.active[data-type="credit"] { color: var(--c-credit); border-bottom: 3px solid var(--c-credit); }
        .type-btn.active[data-type="accounts_payable"] { color: var(--c-ap); border-bottom: 3px solid var(--c-ap); } /* 應付 AP 樣式 */

        /* LIST */
        .row-item { display: grid; grid-template-columns: 2.5rem 1fr 4.5rem 2rem; gap: 0.5rem; padding: 0.6rem 0.5rem; border-bottom: 1px solid #F3F4F6; align-items: center; font-size: 0.85rem; }
        .row-header { background: #F9FAFB; font-size: 0.7rem; color: #6B7280; font-weight: 700; padding: 0.5rem; border-bottom: 1px solid #E5E7EB; }
        
        .btn-delete { width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; color: #D1D5DB; border-radius: 4px; cursor: pointer; }
        .btn-delete:active { background-color: #FEE2E2; color: #DC2626; }
        .btn-config-del { width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; color: #EF4444; border: 1px solid #FECACA; background-color: #FEF2F2; cursor: pointer; border-radius: 4px; transition: all 0.1s; }
        .btn-config-del:active { background-color: #F87171; color: white; }

        /* CREDIT SPECIFIC */
        .btn-settle { width: 1.75rem; height: 1.75rem; border: 1px solid #D1D5DB; background-color: white; color: #D1D5DB; border-radius: 4px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.1s; }
        .btn-settle:hover { border-color: #059669; color: #059669; background-color: #ECFDF5; }
        .btn-settle:active { background-color: #059669; color: white; }
        .row-credit { display: grid; grid-template-columns: 3rem 2.5rem 1fr 4rem; gap: 0.5rem; padding: 0.75rem 0.5rem; border-bottom: 1px solid #F3F4F6; align-items: center; font-size: 0.85rem; }
        .row-payable { display: grid; grid-template-columns: 3rem 2.5rem 1fr 4rem; gap: 0.5rem; padding: 0.75rem 0.5rem; border-bottom: 1px solid #F3F4F6; align-items: center; font-size: 0.85rem; } /* Payable Row 樣式 */

        /* Pagination Button Style */
        .pagination-btn { 
            background: #F3F4F6; 
            color: #6B7280; 
            padding: 0.5rem 0.75rem; 
            font-weight: 600; 
            font-size: 0.75rem; 
            border-radius: 4px; 
            transition: all 0.1s; 
        }
        .pagination-btn:hover:not(:disabled) {
            background-color: #E5E7EB;
        }
        .pagination-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
    </style>
</head>
<body class="flex flex-col bg-white">

    <header class="flex-none bg-white z-20 shadow-sm border-b border-gray-200 h-[50px] flex items-center">
        <div class="px-4 w-full flex justify-between items-center">
            <div class="flex items-center gap-4">
                <button onclick="toggleSidebar()" class="text-gray-600 hover:text-black"><i class="fas fa-bars text-lg"></i></button>
                <h1 id="page-title" class="font-bold tracking-tight text-gray-900 text-sm">系統控制台 (CONSOLE)</h1>
            </div>
        </div>
    </header>

    <div id="sidebar-overlay" onclick="toggleSidebar()" class="fixed inset-0 bg-black/50 z-40 hidden transition-opacity"></div>
    <nav id="sidebar" class="fixed top-0 left-0 bottom-0 w-64 bg-gray-900 z-50 transform -translate-x-full shadow-2xl flex flex-col">
        <div class="p-5 border-b border-gray-800 text-white font-bold text-lg tracking-wider">SYSTEM_LEDGER</div>
        <div class="flex-1 overflow-y-auto">
            <div onclick="route('home')" class="nav-item active" id="nav-home"><div class="nav-icon"><i class="fas fa-calculator"></i></div>控制台 (CONSOLE)</div>
            <div onclick="route('credit')" class="nav-item" id="nav-credit"><div class="nav-icon"><i class="fas fa-file-invoice-dollar"></i></div>賒帳管理 (CREDIT)</div>
            <div onclick="route('payable')" class="nav-item" id="nav-payable"><div class="nav-icon"><i class="fas fa-money-check-alt"></i></div>賒購分析 (AP)</div>
            <div onclick="route('query')" class="nav-item" id="nav-query"><div class="nav-icon"><i class="fas fa-chart-pie"></i></div>商業分析 (BI)</div>
            <div onclick="route('config')" class="nav-item" id="nav-config"><div class="nav-icon"><i class="fas fa-sliders-h"></i></div>系統配置 (CONFIG)</div>
        </div>
        <div class="p-4 border-t border-gray-800 text-gray-500 text-xs font-mono text-center">v10.4 ABSOLUTE_LOCK</div>
    </nav>

    <main class="flex-1 relative w-full overflow-hidden">
        
        <div id="view-home" class="absolute inset-0 flex flex-col bg-white z-0">
            <div class="flex-none overflow-y-auto max-h-[40vh] border-b border-gray-200">
                <div class="border-b border-gray-300">
                    <div class="dash-row-header">今日營運 (<span id="current-system-date">TODAY</span>)</div>
                    <div class="dash-grid-pro">
                        <div class="dash-cell"><span class="label-xs text-emerald-700">營業額</span><span id="day-rev" class="num-font val-md text-emerald-700">0</span></div>
                        <div class="dash-cell bg-amber-50"><span class="label-xs text-amber-700">其中:賒帳</span><span id="day-credit" class="num-font val-md text-amber-700">0</span></div>
                        <div class="dash-cell"><span class="label-xs text-blue-600">毛利率</span><span id="day-margin" class="num-font val-md text-blue-600">0%</span></div>
                    </div>
                    <div class="dash-grid-pro">
                        <div class="dash-cell"><span class="label-xs text-orange-600">成本</span><span id="day-cost" class="num-font val-md text-orange-600">0</span></div>
                        <div class="dash-cell"><span class="label-xs text-rose-600">費用</span><span id="day-exp" class="num-font val-md text-rose-600">0</span></div>
                        <div class="dash-cell bg-gray-50"><span class="label-xs text-gray-900">淨利</span><span id="day-net" class="num-font val-md text-gray-900">0</span></div>
                    </div>
                </div>
                <div class="border-b border-gray-300 mt-2">
                    <div class="dash-row-header">全域累計 (TOTAL HISTORY)</div>
                    <div class="dash-grid-pro">
                        <div class="dash-cell secondary"><span class="label-xs text-gray-500">總營業額</span><span id="all-rev" class="num-font val-md text-gray-600">0</span></div>
                        <div class="dash-cell bg-red-50"><span class="label-xs text-red-600 font-bold">待收帳款 (RISK)</span><span id="all-outstanding" class="num-font val-md text-red-600">0</span></div>
                        <div class="dash-cell secondary"><span class="label-xs text-gray-500">平均毛利</span><span id="all-margin" class="num-font val-md text-blue-600/70">0%</span></div>
                    </div>
                </div>
            </div>

            <div class="flex-1 overflow-y-auto scroll-touch relative bg-white">
                <div class="row-item row-header sticky top-0 z-10 shadow-sm"><div class="pl-1">日期</div><div>項目 / 分類</div><div class="text-right">金額</div><div class="text-center"></div></div>
                <div id="home-ledger-list" class="pb-32"></div>
            </div>

            <section class="absolute bottom-0 left-0 right-0 bg-white border-t border-gray-200 p-3 z-30 shadow-[0_-4px_10px_rgba(0,0,0,0.1)]">
                <div class="flex rounded-sm overflow-hidden border border-gray-200 mb-2">
                    <button onclick="setType('cost')" class="type-btn active flex-1" data-type="cost">成本</button>
                    <button onclick="setType('expense')" class="type-btn flex-1" data-type="expense">費用</button>
                    <button onclick="setType('income')" class="type-btn flex-1" data-type="income">營收</button>
                    <button onclick="setType('credit')" class="type-btn flex-1" data-type="credit">賒帳</button>
                    <button onclick="setType('accounts_payable')" class="type-btn flex-1" data-type="accounts_payable">賒購(AP)</button>
                </div>
                <form onsubmit="commitData(event)" class="grid grid-cols-4 gap-2">
                    <div class="col-span-2"><input type="number" id="in-amt" class="sys-input font-mono font-bold text-lg" placeholder="0.00" required></div>
                    <div class="col-span-2"><select id="in-cat" class="sys-input text-xs font-medium" onchange="updateSubSuggest(); renderCats();"></select></div>
                    <div class="col-span-2 relative"><input type="text" id="in-sub" list="sub-list" class="sys-input text-xs" placeholder="項目說明..."><datalist id="sub-list"></datalist></div>
                    <div class="col-span-2"><input type="date" id="in-date" class="sys-input text-center font-mono text-xs px-0"></div>
                    <button type="submit" class="col-span-4 bg-gray-900 hover:bg-black text-white py-2 text-xs font-bold tracking-widest uppercase">寫入數據</button>
                </form>
            </section>
        </div>

        <div id="view-credit" class="hidden absolute inset-0 flex flex-col bg-white z-0">
            <div class="flex-none bg-white z-10 shadow-sm">
                <div class="p-3 border-b border-gray-200 bg-white">
                    <div class="grid grid-cols-2 gap-3 mb-2">
                        <div><div class="label-xs mb-1">時間維度</div><select id="crm-time-mode" class="sys-input font-mono" onchange="toggleCreditDateInputs()"><option value="day">單獨一日 (SINGLE)</option><option value="range">自定義範圍 (RANGE)</option><option value="all">全域 (ALL)</option></select></div>
                        <div><div class="label-xs mb-1">店鋪</div><select id="crm-cat-filter" class="sys-input" onchange="renderCreditManager()"><option value="all">-- 所有店鋪 --</option></select></div>
                    </div>
                    <div id="crm-date-inputs" class="grid grid-cols-2 gap-3"><input type="date" id="crm-date-start" class="sys-input font-mono text-center" onchange="renderCreditManager()"><input type="date" id="crm-date-end" class="sys-input font-mono text-center hidden" onchange="renderCreditManager()"></div>
                </div>
                <div class="border-b border-gray-300">
                    <div class="dash-row-header bg-amber-50 text-amber-900 border-amber-100 flex justify-between"><span><i class="fas fa-history mr-1"></i> 區間帳務</span><span id="crm-period-label" class="font-mono text-[0.6rem] opacity-70"></span></div>
                    <div class="dash-grid-dual bg-amber-50/30">
                        <div class="dash-cell bg-transparent"><span class="label-xs text-amber-700">期間新增賒帳</span><span id="crm-period-issued" class="num-font val-md text-amber-800">0</span></div>
                        <div class="dash-cell bg-transparent"><span class="label-xs text-red-600">期間未追回</span><span id="crm-period-outstanding" class="num-font val-md text-red-700">0</span></div>
                    </div>
                </div>
                <div class="border-b border-gray-300">
                    <div class="dash-row-header">全域資產狀態 (GLOBAL STOCK)</div>
                    <div class="dash-grid-dual">
                        <div class="dash-cell secondary"><span class="label-xs text-gray-500">歷史總賒帳</span><span id="crm-total-issued" class="num-font val-md text-gray-600">0</span></div>
                        <div class="dash-cell bg-red-50"><span class="label-xs text-red-600 font-bold">目前總未收</span><span id="crm-total-outstanding" class="num-font val-md text-red-600">0</span></div>
                    </div>
                </div>
            </div>
            
            <div class="flex-1 overflow-y-auto scroll-touch bg-gray-50 relative">
                <div class="row-credit bg-gray-100 font-bold text-xs text-gray-500 border-b border-gray-200 sticky top-0 z-20 shadow-sm"><div class="text-center">結清</div><div>日期</div><div>對象 / 項目</div><div class="text-right">金額</div></div>
                <div id="credit-list" class="pb-24"></div>
            </div>

            <section class="flex-none bg-white border-t border-gray-200 p-3 z-30 shadow-[0_-4px_10px_rgba(0,0,0,0.05)] sticky bottom-0">
                <div class="flex justify-between items-center text-xs font-mono">
                    <span id="credit-page-info" class="text-gray-600">Page 1 / 1 (Total 0)</span>
                    <div class="flex gap-2">
                        <button onclick="changePage('credit', -1)" id="credit-btn-prev" class="pagination-btn" disabled>
                            <i class="fas fa-chevron-left"></i> 上一頁
                        </button>
                        <button onclick="changePage('credit', 1)" id="credit-btn-next" class="bg-gray-900 text-white pagination-btn" disabled>
                            下一頁 <i class="fas fa-chevron-right"></i>
                        </button>
                    </div>
                </div>
            </section>
        </div>

        <div id="view-payable" class="hidden absolute inset-0 flex flex-col bg-white z-0">
            <div class="flex-none bg-white z-10 shadow-sm">
                <div class="p-3 border-b border-gray-200 bg-white">
                    <div class="grid grid-cols-2 gap-3 mb-2">
                        <div><div class="label-xs mb-1">時間維度</div><select id="apm-time-mode" class="sys-input font-mono" onchange="togglePayableDateInputs()"><option value="day">單獨一日 (SINGLE)</option><option value="range">自定義範圍 (RANGE)</option><option value="all">全域 (ALL)</option></select></div>
                        <div><div class="label-xs mb-1">分類</div><select id="apm-cat-filter" class="sys-input" onchange="renderPayableManager()"><option value="all">-- 所有分類 --</option></select></div>
                    </div>
                    <div id="apm-date-inputs" class="grid grid-cols-2 gap-3"><input type="date" id="apm-date-start" class="sys-input font-mono text-center" onchange="renderPayableManager()"><input type="date" id="apm-date-end" class="sys-input font-mono text-center hidden" onchange="renderPayableManager()"></div>
                </div>
                <div class="border-b border-gray-300">
                    <div class="dash-row-header bg-blue-50 text-blue-900 border-blue-100 flex justify-between"><span><i class="fas fa-hand-holding-usd mr-1"></i> 區間應付</span><span id="apm-period-label" class="font-mono text-[0.6rem] opacity-70"></span></div>
                    <div class="dash-grid-dual bg-blue-50/30">
                        <div class="dash-cell bg-transparent"><span class="label-xs text-blue-700">期間新增應付</span><span id="apm-period-issued" class="num-font val-md text-blue-800">0</span></div>
                        <div class="dash-cell bg-transparent"><span class="label-xs text-red-600">期間未支付</span><span id="apm-period-outstanding" class="num-font val-md text-red-700">0</span></div>
                    </div>
                </div>
                <div class="border-b border-gray-300">
                    <div class="dash-row-header">全域負債狀態 (GLOBAL LIABILITY)</div>
                    <div class="dash-grid-dual">
                        <div class="dash-cell secondary"><span class="label-xs text-gray-500">歷史總應付</span><span id="apm-total-issued" class="num-font val-md text-gray-600">0</span></div>
                        <div class="dash-cell bg-red-50"><span class="label-xs text-red-600 font-bold">目前總未付</span><span id="apm-total-outstanding" class="num-font val-md text-red-600">0</span></div>
                    </div>
                </div>
            </div>
            
            <div class="flex-1 overflow-y-auto scroll-touch bg-gray-50 relative">
                <div class="row-payable bg-gray-100 font-bold text-xs text-gray-500 border-b border-gray-200 sticky top-0 z-20 shadow-sm"><div class="text-center">支付</div><div>日期</div><div>對象 / 項目</div><div class="text-right">金額</div></div>
                <div id="payable-list" class="pb-24"></div>
            </div>

            <section class="flex-none bg-white border-t border-gray-200 p-3 z-30 shadow-[0_-4px_10px_rgba(0,0,0,0.05)] sticky bottom-0">
                <div class="flex justify-between items-center text-xs font-mono">
                    <span id="payable-page-info" class="text-gray-600">Page 1 / 1 (Total 0)</span>
                    <div class="flex gap-2">
                        <button onclick="changePage('payable', -1)" id="payable-btn-prev" class="pagination-btn" disabled>
                            <i class="fas fa-chevron-left"></i> 上一頁
                        </button>
                        <button onclick="changePage('payable', 1)" id="payable-btn-next" class="bg-gray-900 text-white pagination-btn" disabled>
                            下一頁 <i class="fas fa-chevron-right"></i>
                        </button>
                    </div>
                </div>
            </section>
        </div>


        <div id="view-query" class="hidden absolute inset-0 flex flex-col bg-gray-50 z-0">
            <div class="flex-none z-10 bg-white">
                <div class="bg-white border-b border-gray-200 p-3 shadow-sm space-y-2">
                    <div class="grid grid-cols-2 gap-3">
                        <div><div class="label-xs mb-1">時間維度</div><select id="qry-time-mode" class="sys-input font-mono" onchange="toggleQueryDateInputs()"><option value="month">本月</option><option value="day">單獨一日</option><option value="range">自定義範圍</option><option value="year">今年</option><option value="all">全域</option></select></div>
                        <div><div class="label-xs mb-1">指定店鋪</div><select id="qry-cat" class="sys-input font-bold text-blue-800 bg-blue-50 border-blue-200" onchange="runQuery()"><option value="all">-- 所有店鋪 --</option></select></div>
                    </div>
                    <div id="qry-date-inputs" class="grid grid-cols-2 gap-3 hidden"><input type="date" id="qry-date-start" class="sys-input font-mono text-center" onchange="runQuery()"><input type="date" id="qry-date-end" class="sys-input font-mono text-center hidden" onchange="runQuery()"></div>
                    <div><input type="text" id="qry-keyword" class="sys-input" placeholder="關鍵字搜尋..." oninput="runQuery()"></div>
                </div>
                <div class="bg-white border-b border-gray-200 p-3">
                    <div class="label-xs mb-2 text-gray-800 font-bold border-b border-gray-100 pb-1">分析結果 <span id="qry-period-label" class="font-mono font-normal opacity-50 ml-2"></span></div>
                    <div class="grid grid-cols-3 divide-x divide-gray-100 bg-gray-50 border border-gray-100 rounded-t-sm"><div class="p-2 text-center"><div class="label-xs text-emerald-600">總營業額</div><div id="res-rev" class="num-font font-bold text-sm text-gray-900">0</div></div><div class="p-2 text-center"><div class="label-xs text-orange-600">總成本</div><div id="res-cost" class="num-font font-bold text-sm text-gray-900">0</div></div><div class="p-2 text-center"><div class="label-xs text-rose-600">總費用</div><div id="res-exp" class="num-font font-bold text-sm text-gray-900">0</div></div></div>
                    <div class="grid grid-cols-2 divide-x divide-gray-100 bg-blue-50 border-x border-b border-blue-100 rounded-b-sm"><div class="p-2 text-center"><div class="label-xs text-blue-700">毛利金額</div><div id="res-gp" class="num-font font-bold text-base text-blue-800">0</div></div><div class="p-2 text-center"><div class="label-xs text-blue-700">毛利率</div><div id="res-margin" class="num-font font-bold text-base text-blue-800">0%</div></div></div>
                </div>
            </div>
            
            <div class="flex-1 overflow-y-auto scroll-touch bg-white relative">
                <div class="row-item row-header bg-gray-100 sticky top-0 border-b border-gray-200 z-20 shadow-sm"><div class="pl-1">日期</div><div>檢索結果 (<span id="res-count">0</span>)</div><div class="text-right">金額</div><div></div></div>
                <div id="query-list" class="pb-24"></div>
            </div>

            <section class="flex-none bg-white border-t border-gray-200 p-3 z-30 shadow-[0_-4px_10px_rgba(0,0,0,0.05)] sticky bottom-0">
                <div class="flex justify-between items-center text-xs font-mono">
                    <span id="query-page-info" class="text-gray-600">Page 1 / 1 (Total 0)</span>
                    <div class="flex gap-2">
                        <button onclick="changePage('query', -1)" id="query-btn-prev" class="pagination-btn" disabled>
                            <i class="fas fa-chevron-left"></i> 上一頁
                        </button>
                        <button onclick="changePage('query', 1)" id="query-btn-next" class="bg-gray-900 text-white pagination-btn" disabled>
                            下一頁 <i class="fas fa-chevron-right"></i>
                        </button>
                    </div>
                </div>
            </section>
        </div>

        <div id="view-config" class="hidden absolute inset-0 flex flex-col bg-white p-4 overflow-y-auto scroll-touch z-0">
            <div class="space-y-6 pb-20">
                
                <div>
                    <div class="label-xs mb-2 text-lg border-b border-gray-200 pb-1">交易分類管理 (店鋪/費用)</div>
                    <div class="flex gap-2 mb-3"><input id="new-cat" type="text" class="sys-input text-xs" placeholder="新增交易分類"><button onclick="sysAddCat()" class="bg-gray-900 text-white px-4 text-xs font-bold hover:bg-black">ADD</button></div>
                    <div id="cat-list" class="border border-gray-200 rounded p-1 space-y-1"></div>
                </div>

                <div>
                    <div class="label-xs mb-2 text-lg border-b border-gray-200 pb-1">賒購分類管理 (應付對象)</div>
                    <div class="flex gap-2 mb-3"><input id="new-ap-cat" type="text" class="sys-input text-xs" placeholder="新增賒購分類"><button onclick="sysAddApCat()" class="bg-gray-900 text-white px-4 text-xs font-bold hover:bg-black">ADD</button></div>
                    <div id="ap-cat-list" class="border border-gray-200 rounded p-1 space-y-1"></div>
                </div>

                <div>
                    <div class="label-xs mb-2 text-lg border-b border-gray-200 pb-1">數據 I/O</div>
                    <div class="grid grid-cols-2 gap-3 mb-3">
                        <button onclick="sysExport()" class="border border-gray-300 py-2 text-xs font-bold hover:bg-gray-50">導出 JSON</button>
                        <button onclick="document.getElementById('file-in').click()" class="border border-gray-300 py-2 text-xs font-bold hover:bg-gray-50">導入 JSON</button>
                        <input type="file" id="file-in" class="hidden" onchange="sysImport(this)" multiple>
                    </div>
                    <button onclick="injectMockData()" class="w-full border border-blue-200 text-blue-600 py-2 text-xs font-bold hover:bg-blue-50 mb-3">寫入 1000 筆測試數據 (MOCK)</button>
                    <button onclick="sysPurge()" class="w-full border border-red-200 text-red-600 py-2 text-xs font-bold hover:bg-red-50">重置系統</button>
                </div>
            </div>
        </div>
    </main>

    <div id="modal-alert" class="hidden fixed inset-0 bg-black/60 backdrop-blur-sm z-[60] flex items-center justify-center">
        <div class="bg-white w-72 shadow-2xl rounded-sm overflow-hidden">
            <div class="bg-red-600 text-white px-4 py-2 flex items-center gap-2"><i class="fas fa-exclamation-triangle text-xs"></i><span id="alert-title" class="text-xs font-bold">系統警示</span></div>
            <div class="p-5">
                <div id="alert-msg" class="text-sm font-bold text-gray-900 mb-2">確認執行？</div>
                <div id="alert-detail" class="text-xs text-gray-500 mb-4 font-mono bg-gray-50 p-2 border border-gray-100 rounded hidden"></div>
                <div class="flex gap-2"><button onclick="closeAlert()" class="flex-1 border border-gray-300 py-2 text-xs font-bold text-gray-600 hover:bg-gray-50">取消</button><button onclick="confirmAction()" class="flex-1 bg-red-600 text-white py-2 text-xs font-bold hover:bg-red-700">確認</button></div>
            </div>
        </div>
    </div>

    <script>
        const DB_KEY = 'sys_ledger_v9_7_core';
        const META_KEY = 'sys_ledger_v9_7_meta';
        const DEFAULT_CATS = ['台北總店', '台中分店', '高雄分店', '網路商城', '雜項支出'];
        const DEFAULT_AP_CATS = ['供應商 A', '供應商 B', '個人借款']; // 預設賒購分類
        
        let STATE = { txs: [], cats: [], apCats: [], subs: [], currType: 'cost' }; 
        // 鎖定今日營運數據的日期
        let TODAY_STR = new Date().toLocaleDateString('en-CA');
        
        // --- 分頁狀態 ---
        const PAGINATION_DEFAULTS = {
            pageSize: 100, 
            currentPage: 1,
            totalResults: 0,
            totalPages: 0,
            currentData: []
        };

        let QUERY_PAGINATION = {...PAGINATION_DEFAULTS, view: 'query'};
        let CREDIT_PAGINATION = {...PAGINATION_DEFAULTS, view: 'credit'};
        let PAYABLE_PAGINATION = {...PAGINATION_DEFAULTS, view: 'payable'};
        
        // Alert State
        let actionType = null; let targetId = null; let targetCat = null;

        window.onload = () => { 
            initSystem(); 
            const today = new Date().toLocaleDateString('en-CA');
            
            // 設置當前日期字串 (YYYY-MM-DD 格式)
            TODAY_STR = today; 
            
            // 初始化輸入框日期為當前日期
            document.getElementById('in-date').value = today; 
            // 初始化各模組日期輸入框
            document.getElementById('crm-date-start').value = today;
            document.getElementById('crm-date-end').value = today;
            document.getElementById('apm-date-start').value = today; 
            document.getElementById('apm-date-end').value = today;
            document.getElementById('qry-date-start').value = today;
            document.getElementById('qry-date-end').value = today;

            // 顯示當前日期在 CONSOLE 標題
            document.getElementById('current-system-date').innerText = TODAY_STR;
            
            renderHome(); 
        };

        function toggleSidebar() {
            const sb = document.getElementById('sidebar'), ov = document.getElementById('sidebar-overlay');
            const isOpen = !sb.classList.contains('-translate-x-full');
            if(isOpen){ sb.classList.add('-translate-x-full'); ov.classList.add('hidden'); }
            else{ sb.classList.remove('-translate-x-full'); ov.classList.remove('hidden'); }
        }

        function route(v) {
            document.querySelectorAll('.nav-item').forEach(e=>e.classList.remove('active'));
            document.getElementById(`nav-${v}`).classList.add('active');
            ['home','credit','payable','query','config'].forEach(id => document.getElementById(`view-${id}`).classList.add('hidden')); 
            document.getElementById(`view-${v}`).classList.remove('hidden');
            document.getElementById('page-title').innerText = {'home':'系統控制台 (CONSOLE)','credit':'賒帳管理 (CREDIT)','payable':'賒購分析 (AP)','query':'商業分析 (BI)','config':'系統配置 (CONFIG)'}[v]; 
            toggleSidebar();
            if(v==='home') renderHome();
            if(v==='credit') { renderQueryCats('crm-cat-filter'); toggleCreditDateInputs(); renderCreditManager(); }
            if(v==='payable') { renderPayableQueryCats('apm-cat-filter'); togglePayableDateInputs(); renderPayableManager(); } 
            if(v==='query') { renderQueryCats('qry-cat'); toggleQueryDateInputs(); runQuery(); }
            if(v==='config') { renderCatManager(); renderApCatManager(); }
        }

        // 修改 initSystem 以處理 apCats
        function initSystem() {
            try {
                const db = localStorage.getItem(DB_KEY), meta = localStorage.getItem(META_KEY);
                if(db) STATE.txs = JSON.parse(db);
                if(meta) { 
                    const m = JSON.parse(meta); 
                    STATE.cats = m.cats || DEFAULT_CATS; 
                    STATE.apCats = m.apCats || DEFAULT_AP_CATS; 
                    STATE.subs = m.subs || []; 
                }
                else {
                    STATE.cats = DEFAULT_CATS;
                    STATE.apCats = DEFAULT_AP_CATS; 
                }
            } catch(e) { 
                STATE.cats = DEFAULT_CATS; 
                STATE.apCats = DEFAULT_AP_CATS;
            }
        }

        // 修改 persist 以儲存 apCats
        function persist() {
            localStorage.setItem(DB_KEY, JSON.stringify(STATE.txs));
            localStorage.setItem(META_KEY, JSON.stringify({ cats: STATE.cats, apCats: STATE.apCats, subs: STATE.subs }));
            // 每次儲存後強制刷新 CONSOLE 指標
            if(!document.getElementById('view-home').classList.contains('hidden')) renderMetrics(); 
        }

        function setType(t) { 
            STATE.currType = t; 
            document.querySelectorAll('.type-btn').forEach(b => b.classList.toggle('active', b.dataset.type === t)); 
            renderCats(); 
        }

        function commitData(e) {
            e.preventDefault();
            const amt = parseFloat(document.getElementById('in-amt').value);
            const date = document.getElementById('in-date').value;
            const cat = document.getElementById('in-cat').value;
            const sub = document.getElementById('in-sub').value.trim() || '一般項目';
            if(!amt || !date) return;

            let entry = STATE.subs.find(s => s.cat === cat);
            if(!entry) { entry = { cat, items: [] }; STATE.subs.push(entry); }
            if(!entry.items.includes(sub)) entry.items.push(sub);

            STATE.txs.unshift({ id: Date.now().toString(36), ts: Date.now(), date, type: STATE.currType, cat, sub, amt, isPaid: false });
            persist();
            document.getElementById('in-amt').value = ''; document.getElementById('in-sub').value = ''; document.getElementById('in-amt').focus();
            renderLedgerList();
        }

        // --- 導出 JSON 增強 ---
        function sysExport() {
            if (!confirm('確認導出系統全部數據？')) return;
            
            const defaultFilename = `SYSTEM_LEDGER_${new Date().toISOString().split('T')[0]}`;
            const filename = prompt('請輸入導出檔案名稱:', defaultFilename);

            if (filename === null || filename.trim() === '') {
                alert('導出取消或檔案名稱無效。');
                return;
            }

            const json = JSON.stringify(STATE, null, 2);
            downloadFile(json, `${filename.trim()}.json`);
        }
        
        function downloadFile(content, filename) {
            const blob = new Blob([content], {type: "application/json"});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // --- 導入 JSON 增強 ---
        async function sysImport(input) {
            const files = input.files;
            if (files.length === 0) return;

            if (!confirm(`確認導入並整合 ${files.length} 個檔案的數據？`)) {
                input.value = ''; 
                return;
            }
            
            let totalImportedTxs = 0;
            let combinedTxs = [...STATE.txs];
            let combinedCats = [...STATE.cats];
            let combinedApCats = [...STATE.apCats]; 
            let combinedSubs = [...STATE.subs];

            const filePromises = Array.from(files).map(file => {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        try {
                            const d = JSON.parse(e.target.result);
                            resolve(d);
                        } catch (x) {
                            console.error(`Error parsing file ${file.name}:`, x);
                            resolve(null); 
                        }
                    };
                    reader.onerror = reject;
                    reader.readAsText(file);
                });
            });

            try {
                const results = await Promise.all(filePromises);
                
                results.filter(d => d !== null).forEach(d => {
                    if (Array.isArray(d.txs) && d.txs.length > 0) {
                        const existingIds = new Set(combinedTxs.map(t => t.id).filter(id => id));
                        const newTxs = d.txs.filter(t => t.id && !existingIds.has(t.id));
                        combinedTxs.push(...newTxs);
                        totalImportedTxs += newTxs.length;
                    }

                    if (Array.isArray(d.cats) && d.cats.length > 0) {
                        d.cats.forEach(c => {
                            if (c && !combinedCats.includes(c)) combinedCats.push(c);
                        });
                    }

                    if (Array.isArray(d.apCats) && d.apCats.length > 0) {
                        d.apCats.forEach(c => {
                            if (c && !combinedApCats.includes(c)) combinedApCats.push(c);
                        });
                    }

                    if (Array.isArray(d.subs)) {
                        d.subs.forEach(s => {
                            if (!s.cat) return;
                            const existingIndex = combinedSubs.findIndex(cs => cs.cat === s.cat);
                            if (existingIndex > -1) {
                                if (Array.isArray(s.items)) {
                                    s.items.forEach(item => {
                                        if (item && !combinedSubs[existingIndex].items.includes(item)) {
                                            combinedSubs[existingIndex].items.push(item);
                                        }
                                    });
                                }
                            } else {
                                combinedSubs.push(s);
                            }
                        });
                    }
                });

                STATE.txs = combinedTxs.sort((a,b) => new Date(b.date) - new Date(a.date));
                STATE.cats = combinedCats.filter((v, i, a) => a.indexOf(v) === i); 
                STATE.apCats = combinedApCats.filter((v, i, a) => a.indexOf(v) === i); 
                STATE.subs = combinedSubs;

                persist();
                alert(`數據整合成功！\n\n新增了 ${totalImportedTxs} 筆交易紀錄。\n\n頁面將重整以應用變更。`);
                location.reload();

            } catch (error) {
                alert(`導入過程中發生致命錯誤: ${error}`);
            } finally {
                input.value = '';
            }
        }
        
        // --- ALERT SYSTEM ---
        function openAlert(title, msg, detail = null) {
            document.getElementById('alert-title').innerText = title;
            document.getElementById('alert-msg').innerText = msg;
            const d = document.getElementById('alert-detail');
            if (detail) { d.innerHTML = detail; d.classList.remove('hidden'); } else { d.classList.add('hidden'); }
            document.getElementById('modal-alert').classList.remove('hidden');
        }
        function closeAlert() {
            document.getElementById('modal-alert').classList.add('hidden');
            actionType = null; targetId = null; targetCat = null;
        }
        function promptDeleteTx(id) {
            const t = STATE.txs.find(x => x.id === id); if (!t) return;
            actionType = 'deleteTx'; targetId = id;
            openAlert('刪除紀錄', '確認移除此筆資料？', `ID: ${id}<br>ITEM: ${t.sub} ($${t.amt})`);
        }
        function promptDelCat(cat) {
            actionType = 'deleteCat'; targetCat = cat;
            openAlert('刪除分類', `確認移除交易分類「${cat}」？`, '歷史帳務不會刪除，但選單將不再顯示。');
        }
        
        function promptDelApCat(cat) {
            actionType = 'deleteApCat'; targetCat = cat;
            openAlert('刪除賒購分類', `確認移除賒購分類「${cat}」？`, '歷史帳務不會刪除，但選單將不再顯示。');
        }

        function sysPurge() {
            actionType = 'purge';
            openAlert('重置系統', '警告：將永久刪除所有資料！', '此操作無法復原。');
        }

        function promptPay(id) {
            const t = STATE.txs.find(x => x.id === id); if(!t) return;
            actionType = 'pay_ap'; targetId = id;
            openAlert('確認支付', '此操作將把「應付帳款」標記為「已支付」', `應付金額：$${t.amt}<br>此紀錄將從應付列表中移除`);
        }
        function promptSettle(id) {
            const t = STATE.txs.find(x => x.id === id); if(!t) return;
            actionType = 'settle'; targetId = id;
            openAlert('確認結清', '此操作將把「賒帳」轉為「營收」', `轉入營收：$${t.amt}<br>此紀錄將從賒帳列表中移除`);
        }

        function confirmAction() {
            if (actionType === 'deleteTx' && targetId) {
                STATE.txs = STATE.txs.filter(t => t.id !== targetId);
                persist();
                if(!document.getElementById('view-home').classList.contains('hidden')) renderLedgerList();
                if(!document.getElementById('view-query').classList.contains('hidden')) runQuery(false); 
                if(!document.getElementById('view-credit').classList.contains('hidden')) renderCreditManager(false); 
                if(!document.getElementById('view-payable').classList.contains('hidden')) renderPayableManager(false); 
            } else if (actionType === 'deleteCat' && targetCat) {
                STATE.cats = STATE.cats.filter(c => c !== targetCat);
                persist();
                renderCatManager();
                if(!document.getElementById('view-home').classList.contains('hidden')) renderCats(); 
            } else if (actionType === 'deleteApCat' && targetCat) { 
                STATE.apCats = STATE.apCats.filter(c => c !== targetCat);
                persist();
                renderApCatManager();
                if(!document.getElementById('view-home').classList.contains('hidden')) renderCats(); 
            } else if (actionType === 'purge') {
                localStorage.clear(); location.reload();
            } else if (actionType === 'settle' && targetId) {
                const t = STATE.txs.find(x => x.id === targetId);
                if(t) {
                    t.type = 'income'; 
                    delete t.isPaid;
                    persist();
                    renderCreditManager(false); 
                }
            } else if (actionType === 'pay_ap' && targetId) { 
                const t = STATE.txs.find(x => x.id === targetId);
                if(t) {
                    t.type = 'paid_ap';
                    delete t.isPaid;
                    persist();
                    renderPayableManager(false); 
                }
            }
            closeAlert();
        }
        
        // --- 通用分頁切換函數 ---
        function changePage(view, delta) {
            const P = view === 'query' ? QUERY_PAGINATION : (view === 'payable' ? PAYABLE_PAGINATION : CREDIT_PAGINATION);
            const renderFunc = view === 'query' ? renderQueryResults : (view === 'payable' ? renderPayableList : renderCreditList);
            const newPage = P.currentPage + delta;

            if (newPage >= 1 && newPage <= P.totalPages) {
                P.currentPage = newPage;
                renderFunc();
                const scrollAreaId = view === 'query' ? 'view-query' : (view === 'payable' ? 'view-payable' : 'view-credit');
                document.getElementById(scrollAreaId).querySelector('.scroll-touch').scrollTo(0, 0);
            }
        }

        // --- ACCOUNTING METRICS (鎖定 TODAY_STR) ---
        function renderMetrics() {
            let dCash=0, dCredit=0, dCost=0, dExp=0;
            let aCash=0, aCredit=0, aCost=0, aExp=0, aOut=0;

            STATE.txs.forEach(t => {
                // 排除 accounts_payable 和 paid_ap 兩種負債類別
                if (t.type === 'accounts_payable' || t.type === 'paid_ap') return; 

                let type = (t.type==='debt'||t.type==='receivable')?'credit':t.type;
                if(type === 'income') aCash += t.amt;
                else if(type === 'credit') { aCredit += t.amt; if(!t.isPaid) aOut += t.amt; }
                else if(type === 'cost') aCost += t.amt;
                else if(type === 'expense') aExp += t.amt;

                // 核心修正：只計算日期等於系統當前日期的交易
                if(t.date === TODAY_STR) {
                    if(type === 'income') dCash += t.amt;
                    else if(type === 'credit') dCredit += t.amt;
                    else if(type === 'cost') dCost += t.amt;
                    else if(type === 'expense') dExp += t.amt;
                }
            });

            const dRev = dCash + dCredit; const dGP = dRev - dCost; const dMargin = dRev > 0 ? (dGP / dRev) * 100 : 0; const dNet = dGP - dExp;
            const aRev = aCash + aCredit; const aGP = aRev - aCost; const aMargin = aRev > 0 ? (aGP / aRev) * 100 : 0; 
            
            const fmt = new Intl.NumberFormat('en-US');
            document.getElementById('day-rev').innerText = fmt.format(dRev);
            document.getElementById('day-credit').innerText = fmt.format(dCredit);
            document.getElementById('day-margin').innerText = dMargin.toFixed(1) + '%';
            document.getElementById('day-cost').innerText = fmt.format(dCost);
            document.getElementById('day-exp').innerText = fmt.format(dExp);
            document.getElementById('day-net').innerText = fmt.format(dNet);

            document.getElementById('all-rev').innerText = fmt.format(aRev);
            document.getElementById('all-outstanding').innerText = fmt.format(aOut);
            document.getElementById('all-margin').innerText = aMargin.toFixed(1) + '%';
        }

        // --- CREDIT MANAGER LOGIC (分頁) ---
        function toggleCreditDateInputs() {
            const mode = document.getElementById('crm-time-mode').value;
            const start = document.getElementById('crm-date-start');
            const end = document.getElementById('crm-date-end');
            if (mode === 'day') { start.classList.remove('hidden'); end.classList.add('hidden'); } 
            else if (mode === 'range') { start.classList.remove('hidden'); end.classList.remove('hidden'); } 
            else { start.classList.add('hidden'); end.classList.add('hidden'); }
            renderCreditManager();
        }

        function renderCreditList() {
            const list = document.getElementById('credit-list'); list.innerHTML = '';
            const { currentPage, pageSize, totalResults, totalPages, currentData } = CREDIT_PAGINATION;

            const start = (currentPage - 1) * pageSize;
            const end = start + pageSize;
            const paginatedData = currentData.slice(start, end);

            if(paginatedData.length === 0) list.innerHTML = '<div class="text-center py-10 text-gray-300 text-xs font-mono">該期間無紀錄</div>';
            else paginatedData.forEach(t => {
                const row = document.createElement('div');
                row.className = 'row-credit';
                row.innerHTML = `<div class="flex justify-center"><button onclick="promptSettle('${t.id}')" class="btn-settle" title="結清轉入營收"><i class="fas fa-check text-xs"></i></button></div><div class="num-font text-xs text-gray-500">${t.date.slice(5)}</div><div class="text-info truncate"><div class="font-bold text-xs truncate">${t.sub}</div><div class="text-[0.6rem] text-gray-400 font-mono uppercase">${t.cat}</div></div><div class="text-right num-font font-bold text-xs text-amt text-amber-600">$${t.amt.toLocaleString()}</div>`;
                list.appendChild(row);
            });

            document.getElementById('credit-page-info').innerText = `Page ${currentPage} / ${totalPages} (Total ${totalResults})`;
            document.getElementById('credit-btn-prev').disabled = (currentPage <= 1);
            document.getElementById('credit-btn-next').disabled = (currentPage >= totalPages);
        }

        function renderCreditManager(resetPage = true) {
            const mode = document.getElementById('crm-time-mode').value;
            const catFilter = document.getElementById('crm-cat-filter').value;
            const startDate = document.getElementById('crm-date-start').value;
            const endDate = document.getElementById('crm-date-end').value;

            let periodLabel = "ALL TIME";
            if(mode === 'day') periodLabel = startDate; else if(mode === 'range') periodLabel = `${startDate} ~ ${endDate}`;
            document.getElementById('crm-period-label').innerText = periodLabel;

            let allCredits = STATE.txs.filter(t => (t.type === 'credit' || t.type === 'receivable' || t.type === 'debt'));
            if(catFilter !== 'all') allCredits = allCredits.filter(t => t.cat === catFilter);

            let totalIssued=0, totalOutstanding=0;
            let periodIssued=0, periodOutstanding=0;

            allCredits.forEach(t => {
                totalIssued += t.amt; 
                totalOutstanding += t.amt; 
            });

            const listItems = allCredits.filter(t => {
                let inRange = true;
                if (mode === 'day') inRange = (t.date === startDate);
                else if (mode === 'range') inRange = (t.date >= startDate && t.date <= endDate);
                if (inRange) { periodIssued += t.amt; periodOutstanding += t.amt; }
                return inRange;
            });

            const fmt = new Intl.NumberFormat('en-US');
            document.getElementById('crm-period-issued').innerText = fmt.format(periodIssued);
            document.getElementById('crm-period-outstanding').innerText = fmt.format(periodOutstanding);
            document.getElementById('crm-total-issued').innerText = fmt.format(totalIssued);
            document.getElementById('crm-total-outstanding').innerText = fmt.format(totalOutstanding);

            CREDIT_PAGINATION.currentData = listItems;
            CREDIT_PAGINATION.totalResults = listItems.length;
            CREDIT_PAGINATION.totalPages = Math.ceil(listItems.length / CREDIT_PAGINATION.pageSize);
            if (resetPage) CREDIT_PAGINATION.currentPage = 1;
            
            renderCreditList();
        }

        // --- PAYABLE MANAGER LOGIC (應付帳款) ---
        function togglePayableDateInputs() {
            const mode = document.getElementById('apm-time-mode').value;
            const start = document.getElementById('apm-date-start');
            const end = document.getElementById('apm-date-end');
            if (mode === 'day') { start.classList.remove('hidden'); end.classList.add('hidden'); } 
            else if (mode === 'range') { start.classList.remove('hidden'); end.classList.remove('hidden'); } 
            else { start.classList.add('hidden'); end.classList.add('hidden'); }
            renderPayableManager();
        }

        function renderPayableList() {
            const list = document.getElementById('payable-list'); list.innerHTML = '';
            const { currentPage, pageSize, totalResults, totalPages, currentData } = PAYABLE_PAGINATION;

            const start = (currentPage - 1) * pageSize;
            const end = start + pageSize;
            const paginatedData = currentData.slice(start, end);

            if(paginatedData.length === 0) list.innerHTML = '<div class="text-center py-10 text-gray-300 text-xs font-mono">該期間無紀錄</div>';
            else paginatedData.forEach(t => {
                const row = document.createElement('div');
                row.className = 'row-payable';
                row.innerHTML = `<div class="flex justify-center"><button onclick="promptPay('${t.id}')" class="btn-settle bg-blue-50 hover:border-blue-700 hover:text-blue-700 active:bg-blue-700 active:text-white" title="標記為已支付"><i class="fas fa-check text-xs"></i></button></div><div class="num-font text-xs text-gray-500">${t.date.slice(5)}</div><div class="text-info truncate"><div class="font-bold text-xs truncate">${t.sub}</div><div class="text-[0.6rem] text-gray-400 font-mono uppercase">${t.cat}</div></div><div class="text-right num-font font-bold text-xs text-amt text-blue-600">$${t.amt.toLocaleString()}</div>`;
                list.appendChild(row);
            });

            document.getElementById('payable-page-info').innerText = `Page ${currentPage} / ${totalPages} (Total ${totalResults})`;
            document.getElementById('payable-btn-prev').disabled = (currentPage <= 1);
            document.getElementById('payable-btn-next').disabled = (currentPage >= totalPages);
        }

        function renderPayableManager(resetPage = true) {
            const mode = document.getElementById('apm-time-mode').value;
            const catFilter = document.getElementById('apm-cat-filter').value;
            const startDate = document.getElementById('apm-date-start').value;
            const endDate = document.getElementById('apm-date-end').value;

            let periodLabel = "ALL TIME";
            if(mode === 'day') periodLabel = startDate; else if(mode === 'range') periodLabel = `${startDate} ~ ${endDate}`;
            document.getElementById('apm-period-label').innerText = periodLabel;

            let allPayables = STATE.txs.filter(t => (t.type === 'accounts_payable'));
            if(catFilter !== 'all') allPayables = allPayables.filter(t => t.cat === catFilter);

            let totalIssued=0, totalOutstanding=0;
            let periodIssued=0, periodOutstanding=0;

            allPayables.forEach(t => {
                totalIssued += t.amt; 
                totalOutstanding += t.amt; 
            });

            const listItems = allPayables.filter(t => {
                let inRange = true;
                if (mode === 'day') inRange = (t.date === startDate);
                else if (mode === 'range') inRange = (t.date >= startDate && t.date <= endDate);
                if (inRange) { periodIssued += t.amt; periodOutstanding += t.amt; }
                return inRange;
            });

            const fmt = new Intl.NumberFormat('en-US');
            document.getElementById('apm-period-issued').innerText = fmt.format(periodIssued);
            document.getElementById('apm-period-outstanding').innerText = fmt.format(periodOutstanding);
            document.getElementById('apm-total-issued').innerText = fmt.format(totalIssued);
            document.getElementById('apm-total-outstanding').innerText = fmt.format(totalOutstanding);

            PAYABLE_PAGINATION.currentData = listItems;
            PAYABLE_PAGINATION.totalResults = listItems.length;
            PAYABLE_PAGINATION.totalPages = Math.ceil(listItems.length / PAYABLE_PAGINATION.pageSize);
            if (resetPage) PAYABLE_PAGINATION.currentPage = 1;
            
            renderPayableList();
        }

        // --- QUERY LOGIC (分頁, 排除 accounts_payable 和 paid_ap) ---
        function toggleQueryDateInputs() {
            const mode = document.getElementById('qry-time-mode').value;
            const start = document.getElementById('qry-date-start');
            const end = document.getElementById('qry-date-end');
            const needsInputs = (mode === 'day' || mode === 'range');
            const needsEnd = (mode === 'range');
            if(needsInputs) document.getElementById('qry-date-inputs').classList.remove('hidden'); else document.getElementById('qry-date-inputs').classList.add('hidden');
            start.classList.remove('hidden');
            if(needsEnd) end.classList.remove('hidden'); else end.classList.add('hidden');
            runQuery();
        }

        // 獨立計算指標 (排除 accounts_payable 和 paid_ap)
        function renderQueryMetrics(data) {
            let cash=0, credit=0, cost=0, exp=0;
            data.forEach(t => {
                if (t.type === 'accounts_payable' || t.type === 'paid_ap') return; 

                let tp = (t.type==='debt'||t.type==='receivable')?'credit':t.type;
                if(tp==='income') cash+=t.amt; else if(tp==='credit') credit+=t.amt; else if(tp==='cost') cost+=t.amt; else if(tp==='expense') exp+=t.amt;
            });
            const rev = cash + credit; const gp = rev - cost; const m = rev>0?(gp/rev)*100:0;
            const f = new Intl.NumberFormat('en-US');
            document.getElementById('res-rev').innerText = f.format(rev);
            document.getElementById('res-cost').innerText = f.format(cost);
            document.getElementById('res-exp').innerText = f.format(exp);
            document.getElementById('res-gp').innerText = f.format(gp);
            document.getElementById('res-margin').innerText = m.toFixed(1)+'%';
            document.getElementById('res-count').innerText = data.length;
        }

        function renderQueryResults() {
            const data = QUERY_PAGINATION.currentData;
            const l = document.getElementById('query-list'); l.innerHTML = '';
            
            const { currentPage, pageSize, totalResults, totalPages } = QUERY_PAGINATION;
            
            const start = (currentPage - 1) * pageSize;
            const end = start + pageSize;
            const paginatedData = data.slice(start, end);

            if(!paginatedData.length) l.innerHTML='<div class="text-center py-10 text-gray-300 text-xs font-mono">無符合數據</div>';
            else paginatedData.forEach(t => l.appendChild(createRow(t)));
            
            document.getElementById('query-page-info').innerText = `Page ${currentPage} / ${totalPages} (Total ${totalResults})`;
            document.getElementById('query-btn-prev').disabled = (currentPage <= 1);
            document.getElementById('query-btn-next').disabled = (currentPage >= totalPages);
        }

        function runQuery(resetPage = true) {
            const tm = document.getElementById('qry-time-mode').value;
            const kw = document.getElementById('qry-keyword').value.trim().toLowerCase();
            const cat = document.getElementById('qry-cat').value;
            const now = new Date(); let s, e;
            if(tm==='month'){s=new Date(now.getFullYear(),now.getMonth(),1);e=new Date(now.getFullYear(),now.getMonth()+1,0);}
            else if(tm==='year'){s=new Date(now.getFullYear(),0,1);e=new Date(now.getFullYear(),11,31);}
            else if(tm==='day') { const d=document.getElementById('qry-date-start').value; if(d){s=new Date(d);e=new Date(d);} }
            else if(tm==='range') { const d1=document.getElementById('qry-date-start').value; const d2=document.getElementById('qry-date-end').value; if(d1)s=new Date(d1); if(d2)e=new Date(d2); }

            let label = ""; if(s&&e){ const fd=d=>d.toISOString().split('T')[0]; if(s.getTime()===e.getTime()) label=fd(s); else label=`${fd(s)} ~ ${fd(e)}`; } else if(tm==='all') label="ALL TIME";
            document.getElementById('qry-period-label').innerText = label;

            const res = STATE.txs.filter(t => {
                if(cat!=='all' && t.cat!==cat) return false;
                if(kw && !(t.sub.toLowerCase().includes(kw) || t.cat.toLowerCase().includes(kw))) return false;
                if(tm!=='all' && s && e) { const d=new Date(t.date); if(d<s || d>e) return false; }
                return true;
            });
            
            QUERY_PAGINATION.currentData = res;
            QUERY_PAGINATION.totalResults = res.length;
            QUERY_PAGINATION.totalPages = Math.ceil(res.length / QUERY_PAGINATION.pageSize);
            if (resetPage) QUERY_PAGINATION.currentPage = 1;

            renderQueryMetrics(res);
            renderQueryResults();
        }

        // --- SHARED ---
        function renderHome() { renderCats(); renderLedgerList(); renderMetrics(); updateSubSuggest(); }
        
        function renderLedgerList() {
            const list = document.getElementById('home-ledger-list'); list.innerHTML = '';
            const data = STATE.txs.slice(0, 10); 
            if(!data.length) { list.innerHTML = '<div class="text-center py-10 text-gray-300 text-xs font-mono">暫無數據</div>'; return; }
            data.forEach(t => list.appendChild(createRow(t)));
        }

        function createRow(t) {
            const row = document.createElement('div'); row.className = 'row-item hover:bg-gray-50 transition-colors';
            let color='text-gray-900', sign='', type=(t.type==='debt'||t.type==='receivable')?'credit':t.type;

            if(t.type === 'accounts_payable') { 
                color='text-blue-600';
                sign='+'; 
            }
            else if(t.type === 'paid_ap') { 
                color='text-gray-400 line-through';
                sign='=';
            }
            else if(type==='income'){color='text-emerald-700';sign='+';} 
            else if(type==='credit'){color='text-amber-700';sign='+';} 
            else if(type==='cost'){color='text-orange-700';sign='-';} 
            else if(type==='expense'){color='text-rose-700';sign='-';}

            row.innerHTML = `<div class="num-font text-xs text-gray-500 pl-1">${t.date.slice(5)}</div><div class="truncate"><div class="font-bold text-gray-900 text-xs truncate">${t.sub}</div><div class="text-[0.6rem] text-gray-400 font-mono uppercase bg-gray-100 px-1 rounded-sm inline-block mt-0.5">${t.cat}</div></div><div class="text-right num-font font-bold text-xs ${color}">${sign}${t.amt.toLocaleString()}</div><div class="text-center flex justify-center"><div onclick="promptDeleteTx('${t.id}')" class="btn-delete" role="button"><i class="fas fa-times"></i></div></div>`;
            return row;
        }

        // 修改 renderCats 以根據當前類型切換分類來源
        function renderCats() { 
            const s=document.getElementById('in-cat'); 
            const v=s.value; 
            s.innerHTML=''; 
            
            let categories = STATE.cats;
            // 如果當前選中的是應付帳款，則使用 apCats (賒購分類)
            if (STATE.currType === 'accounts_payable') {
                categories = STATE.apCats;
            } else {
                categories = STATE.cats;
            }

            categories.forEach(c=>{const o=document.createElement('option');o.value=c;o.text=c;s.add(o)}); 
            if(categories.includes(v))s.value=v; 
            updateSubSuggest(); 
        }
        
        function renderQueryCats(id) { 
            const s=document.getElementById(id); 
            const v=s.value; 
            s.innerHTML='<option value="all">-- 所有店鋪/分類 --</option>'; 
            STATE.cats.forEach(c=>{const o=document.createElement('option');o.value=c;o.text=c;s.add(o)}); 
            s.value=v; 
        }

        function renderPayableQueryCats(id) { 
            const s=document.getElementById(id); 
            const v=s.value; 
            s.innerHTML='<option value="all">-- 所有分類 --</option>'; 
            STATE.apCats.forEach(c=>{const o=document.createElement('option');o.value=c;o.text=c;s.add(o)}); 
            s.value=v; 
        }

        function updateSubSuggest() { 
            const c=document.getElementById('in-cat').value; 
            const l=document.getElementById('sub-list'); 
            l.innerHTML=''; 
            const e=STATE.subs.find(x=>x.cat===c); 
            if(e)e.items.forEach(i=>{const o=document.createElement('option');o.value=i;l.appendChild(o)}); 
        }
        
        function renderCatManager() {
            const l=document.getElementById('cat-list'); l.innerHTML=''; 
            STATE.cats.forEach(c=>{ 
                const d=document.createElement('div'); 
                d.className='flex justify-between items-center text-xs bg-gray-50 px-2 py-2 border-b border-gray-100'; 
                const s = document.createElement('span'); s.innerText = c;
                const b = document.createElement('button');
                b.type = 'button'; b.className = 'btn-config-del';
                b.innerHTML = '<i class="fas fa-times"></i>';
                b.onclick = function() { promptDelCat(c); };
                d.appendChild(s); d.appendChild(b); l.appendChild(d); 
            }); 
        }
        
        function renderApCatManager() {
            const l=document.getElementById('ap-cat-list'); l.innerHTML=''; 
            STATE.apCats.forEach(c=>{ 
                const d=document.createElement('div'); 
                d.className='flex justify-between items-center text-xs bg-gray-50 px-2 py-2 border-b border-gray-100'; 
                const s = document.createElement('span'); s.innerText = c;
                const b = document.createElement('button');
                b.type = 'button'; b.className = 'btn-config-del';
                b.innerHTML = '<i class="fas fa-times"></i>';
                b.onclick = function() { promptDelApCat(c); }; 
                d.appendChild(s); d.appendChild(b); l.appendChild(d); 
            }); 
        }

        function sysAddCat() { 
            const v=document.getElementById('new-cat').value.trim(); 
            if(v&&!STATE.cats.includes(v)){ 
                STATE.cats.push(v); 
                persist(); 
                renderCatManager(); 
                document.getElementById('new-cat').value=''; 
            } 
        }

        function sysAddApCat() { 
            const v=document.getElementById('new-ap-cat').value.trim(); 
            if(v&&!STATE.apCats.includes(v)){ 
                STATE.apCats.push(v); 
                persist(); 
                renderApCatManager(); 
                document.getElementById('new-ap-cat').value=''; 
            } 
        }
        
        // --- NEW MOCK DATA GENERATOR ---
        function injectMockData() {
            if(!confirm('這將產生 1000 筆隨機測試數據並混合到現有資料中，確定執行？')) return;
            const types = ['income', 'cost', 'expense', 'credit', 'accounts_payable'];
            const cats = STATE.cats;
            const subs = ['商品A', '商品B', '服務費', '雜費', '進貨', '租金', '水電', '物流費', '借入資金'];
            
            for(let i=0; i<1000; i++) {
                const dateObj = new Date();
                dateObj.setDate(dateObj.getDate() - Math.floor(Math.random() * 365));
                const date = dateObj.toISOString().split('T')[0];
                const type = types[Math.floor(Math.random() * types.length)];
                
                let cat;
                if (type === 'accounts_payable') {
                    cat = STATE.apCats[Math.floor(Math.random() * STATE.apCats.length)];
                } else {
                    cat = cats[Math.floor(Math.random() * cats.length)];
                }

                const sub = subs[Math.floor(Math.random() * subs.length)];
                const amt = Math.floor(Math.random() * 5000) + 100;
                
                STATE.txs.push({
                    id: Math.random().toString(36).substr(2, 9),
                    ts: Date.now(),
                    date, type, cat, sub, amt,
                    isPaid: type === 'credit' ? false : undefined
                });
            }
            // Sort by date desc
            STATE.txs.sort((a,b) => new Date(b.date) - new Date(a.date));
            persist();
            alert('已生成 1000 筆測試數據！頁面將重整。');
            location.reload();
        }
    </script>
</body>
</html>